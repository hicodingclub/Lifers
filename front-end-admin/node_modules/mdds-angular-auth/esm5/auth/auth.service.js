/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Inject } from '@angular/core';
import { HttpClient, HttpParams } from '@angular/common/http';
import { catchError, map } from 'rxjs/operators';
import { Router, NavigationEnd } from '@angular/router';
import { AUTHTICATION_SERVER_ROOT_URI } from './tokens';
var AuthenticationService = /** @class */ (function () {
    function AuthenticationService(authServerRootUri, router, http) {
        var _this = this;
        this.authServerRootUri = authServerRootUri;
        this.router = router;
        this.http = http;
        this.adminInterface = false;
        this.navigateEndTime = Date.now();
        router.events.subscribe(function (event) {
            if (event instanceof NavigationEnd) {
                _this.previousUrl = _this.currentUrl;
                _this.navigateEndTime = Date.now();
                if (event.urlAfterRedirects) {
                    _this.currentUrl = event.urlAfterRedirects;
                }
                else {
                    _this.currentUrl = event.url;
                }
            }
        });
        this.adminInterface = JSON.parse(localStorage.getItem('adminInterface'));
    }
    /**
     * @return {?}
     */
    AuthenticationService.prototype.isAuthorized = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
        if (authRecord && authRecord['accessToken']) {
            return true;
        }
        return false;
    };
    /**
     * @private
     * @return {?}
     */
    AuthenticationService.prototype.getLogoutTime = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
        if (authRecord && 'logoutTs' in authRecord) {
            return authRecord.logoutTs;
        }
        return 0;
    };
    /**
     * @return {?}
     */
    AuthenticationService.prototype.getAccessToken = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
        if (authRecord) {
            return authRecord['accessToken'];
        }
        return null;
    };
    /**
     * @return {?}
     */
    AuthenticationService.prototype.refreshToken = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
        if (!authRecord) {
            authRecord = { refreshToken: '', userName: '' };
        }
        /** @type {?} */
        var refreshToken = authRecord['refreshToken'];
        /** @type {?} */
        var userName = authRecord['userName'];
        return this.http.post(this.authServerRootUri + '/refresh', { refreshToken: refreshToken, userName: userName }).pipe(map(this.loggedIn), catchError(function (error) {
            _this.logout();
            return error;
        }));
    };
    /**
     * @param {?} response
     * @return {?}
     */
    AuthenticationService.prototype.refreshShouldHappen = /**
     * @param {?} response
     * @return {?}
     */
    function (response) {
        return response.status === 401;
    };
    /**
     * @param {?} url
     * @return {?}
     */
    AuthenticationService.prototype.verifyTokenRequest = /**
     * @param {?} url
     * @return {?}
     */
    function (url) {
        if (url.endsWith(this.authServerRootUri + '/refresh') ||
            url.endsWith(this.authServerRootUri + '/login')) {
            return true;
        }
        return false;
    };
    /**
     * @return {?}
     */
    AuthenticationService.prototype.getInterruptedUrl = /**
     * @return {?}
     */
    function () {
        return this.interruptedUrl || '/';
    };
    /**
     * @return {?}
     */
    AuthenticationService.prototype.getRoutedFromUrl = /**
     * @return {?}
     */
    function () {
        return this.routedFromUrl || '/';
    };
    /**
     * @param {?} url
     * @return {?}
     */
    AuthenticationService.prototype.setInterruptedUrl = /**
     * @param {?} url
     * @return {?}
     */
    function (url) {
        this.interruptedUrl = url;
        /** @type {?} */
        var currentTime = Date.now();
        if (currentTime - this.navigateEndTime > 1000) {
            // Happend > 1 sec. assume it is triggered from current page.
            this.routedFromUrl = this.currentUrl;
        }
        else {
            // page transitioned
            this.routedFromUrl = this.previousUrl;
        }
    };
    /**
     * @return {?}
     */
    AuthenticationService.prototype.getUserName = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
        if (!authRecord) {
            authRecord = { userName: '' };
        }
        return authRecord['userName'];
    };
    /**
     * @param {?} userName
     * @param {?} password
     * @return {?}
     */
    AuthenticationService.prototype.login = /**
     * @param {?} userName
     * @param {?} password
     * @return {?}
     */
    function (userName, password) {
        /** @type {?} */
        var authRecord = {
            userName: userName,
            accessToken: '',
            refreshToken: '',
            displayName: ''
        };
        localStorage.setItem('mdds-auth-record', JSON.stringify(authRecord));
        /** @type {?} */
        var options = this.adminInterface ?
            { params: new HttpParams().set('type', 'admin') } : {};
        return this.http.post(this.authServerRootUri + '/login', { username: userName, password: password }, options).pipe(map(this.loggedIn));
    };
    /**
     * @param {?} userInfo
     * @return {?}
     */
    AuthenticationService.prototype.register = /**
     * @param {?} userInfo
     * @return {?}
     */
    function (userInfo) {
        localStorage.removeItem('mdds-auth-record');
        /** @type {?} */
        var authRecord = {
            userName: userInfo.userName,
            accessToken: '',
            refreshToken: '',
            displayName: userInfo.displayName
        };
        localStorage.setItem('mdds-auth-record', JSON.stringify(authRecord));
        /** @type {?} */
        var options = this.adminInterface ?
            { params: new HttpParams().set('type', 'admin') } : {};
        return this.http.post(this.authServerRootUri + '/register', userInfo, options);
    };
    /**
     * @param {?} user
     * @return {?}
     */
    AuthenticationService.prototype.loggedIn = /**
     * @param {?} user
     * @return {?}
     */
    function (user) {
        /** @type {?} */
        var authRecord = {
            userName: '',
            accessToken: '',
            refreshToken: '',
            displayName: ''
        };
        if (user && user.accessToken) {
            authRecord['accessToken'] = user.accessToken;
        }
        if (user && user.refreshToken) {
            authRecord['refreshToken'] = user.refreshToken;
        }
        if (user && user.displayName) {
            authRecord['displayName'] = user.displayName;
        }
        if (user && user.userName) {
            authRecord['userName'] = user.userName;
        }
        localStorage.setItem('mdds-auth-record', JSON.stringify(authRecord));
        return user;
    };
    /**
     * @return {?}
     */
    AuthenticationService.prototype.logout = /**
     * @return {?}
     */
    function () {
        // remove user from local storage to log user out
        /** @type {?} */
        var authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
        if (!authRecord) {
            authRecord = {};
        }
        authRecord.logoutTs = Date.now();
        authRecord.accessToken = '';
        authRecord.refreshToken = '';
        localStorage.setItem('mdds-auth-record', JSON.stringify(authRecord));
    };
    /**
     * @param {?} isAdminInterface
     * @return {?}
     */
    AuthenticationService.prototype.setAdminInterface = /**
     * @param {?} isAdminInterface
     * @return {?}
     */
    function (isAdminInterface) {
        this.adminInterface = isAdminInterface;
        localStorage.setItem('adminInterface', JSON.stringify(isAdminInterface));
    };
    /**
     * @return {?}
     */
    AuthenticationService.prototype.isAdminInterface = /**
     * @return {?}
     */
    function () {
        return this.adminInterface;
    };
    AuthenticationService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    AuthenticationService.ctorParameters = function () { return [
        { type: String, decorators: [{ type: Inject, args: [AUTHTICATION_SERVER_ROOT_URI,] }] },
        { type: Router },
        { type: HttpClient }
    ]; };
    return AuthenticationService;
}());
export { AuthenticationService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    AuthenticationService.prototype.interruptedUrl;
    /**
     * @type {?}
     * @private
     */
    AuthenticationService.prototype.routedFromUrl;
    /**
     * @type {?}
     * @private
     */
    AuthenticationService.prototype.previousUrl;
    /**
     * @type {?}
     * @private
     */
    AuthenticationService.prototype.currentUrl;
    /**
     * @type {?}
     * @private
     */
    AuthenticationService.prototype.navigateEndTime;
    /**
     * @type {?}
     * @private
     */
    AuthenticationService.prototype.adminInterface;
    /**
     * @type {?}
     * @private
     */
    AuthenticationService.prototype.authServerRootUri;
    /**
     * @type {?}
     * @private
     */
    AuthenticationService.prototype.router;
    /**
     * @type {?}
     * @private
     */
    AuthenticationService.prototype.http;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbWRkcy1hbmd1bGFyLWF1dGgvIiwic291cmNlcyI6WyJhdXRoL2F1dGguc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQWtDLE1BQU0sc0JBQXNCLENBQUM7QUFDOUYsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQWlCLE1BQU0sZ0JBQWdCLENBQUM7QUFFaEUsT0FBTyxFQUFFLE1BQU0sRUFBRSxhQUFhLEVBQUcsTUFBTSxpQkFBaUIsQ0FBQztBQUV6RCxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFeEQ7SUFZRSwrQkFDd0QsaUJBQXlCLEVBQy9ELE1BQWMsRUFDZCxJQUFnQjtRQUhsQyxpQkFtQkM7UUFsQnVELHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBUTtRQUMvRCxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2QsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUwxQixtQkFBYyxHQUFZLEtBQUssQ0FBQztRQU10QyxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUVsQyxNQUFNLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxVQUFBLEtBQUs7WUFDM0IsSUFBSSxLQUFLLFlBQVksYUFBYSxFQUFFO2dCQUNsQyxLQUFJLENBQUMsV0FBVyxHQUFHLEtBQUksQ0FBQyxVQUFVLENBQUM7Z0JBQ25DLEtBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO2dCQUNsQyxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsRUFBRTtvQkFDM0IsS0FBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUMsaUJBQWlCLENBQUM7aUJBQzNDO3FCQUFNO29CQUNMLEtBQUksQ0FB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QUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQztJQUMzRSxDQUFDOzs7O0lBRUQsZ0RBQWdCOzs7SUFBaEI7UUFDRSxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUM7SUFDN0IsQ0FBQzs7Z0JBbk1GLFVBQVU7Ozs7NkNBYUUsTUFBTSxTQUFDLDRCQUE0QjtnQkFqQnZDLE1BQU07Z0JBSE4sVUFBVTs7SUEyTW5CLDRCQUFDO0NBQUEsQUFwTUQsSUFvTUM7U0FuTVkscUJBQXFCOzs7Ozs7SUFFaEMsK0NBQStCOzs7OztJQUMvQiw4Q0FBOEI7Ozs7O0lBRTlCLDRDQUE0Qjs7Ozs7SUFDNUIsMkNBQTJCOzs7OztJQUMzQixnREFBZ0M7Ozs7O0lBRWhDLCtDQUF3Qzs7Ozs7SUFHOUIsa0RBQXVFOzs7OztJQUN2RSx1Q0FBc0I7Ozs7O0lBQ3RCLHFDQUF3QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cFBhcmFtcywgSHR0cEhlYWRlcnMsIEh0dHBFcnJvclJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwLCBmaWx0ZXIsIHJldHJ5IH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFJvdXRlciwgTmF2aWdhdGlvbkVuZCAgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuXG5pbXBvcnQgeyBBVVRIVElDQVRJT05fU0VSVkVSX1JPT1RfVVJJIH0gZnJvbSAnLi90b2tlbnMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQXV0aGVudGljYXRpb25TZXJ2aWNlIHtcblxuICBwcml2YXRlIGludGVycnVwdGVkVXJsOiBzdHJpbmc7XG4gIHByaXZhdGUgcm91dGVkRnJvbVVybDogc3RyaW5nO1xuXG4gIHByaXZhdGUgcHJldmlvdXNVcmw6IHN0cmluZztcbiAgcHJpdmF0ZSBjdXJyZW50VXJsOiBzdHJpbmc7XG4gIHByaXZhdGUgbmF2aWdhdGVFbmRUaW1lOiBudW1iZXI7XG4gIFxuICBwcml2YXRlIGFkbWluSW50ZXJmYWNlOiBib29sZWFuID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgICAgICAgICBASW5qZWN0KEFVVEhUSUNBVElPTl9TRVJWRVJfUk9PVF9VUkkpIHByaXZhdGUgYXV0aFNlcnZlclJvb3RVcmk6IHN0cmluZyxcbiAgICAgICAgICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsXG4gICAgICAgICAgICBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQpIHtcbiAgICB0aGlzLm5hdmlnYXRlRW5kVGltZSA9IERhdGUubm93KCk7XG5cbiAgICByb3V0ZXIuZXZlbnRzLnN1YnNjcmliZShldmVudCA9PiB7XG4gICAgICBpZiAoZXZlbnQgaW5zdGFuY2VvZiBOYXZpZ2F0aW9uRW5kKSB7XG4gICAgICAgIHRoaXMucHJldmlvdXNVcmwgPSB0aGlzLmN1cnJlbnRVcmw7XG4gICAgICAgIHRoaXMubmF2aWdhdGVFbmRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgICAgaWYgKGV2ZW50LnVybEFmdGVyUmVkaXJlY3RzKSB7XG4gICAgICAgICAgdGhpcy5jdXJyZW50VXJsID0gZXZlbnQudXJsQWZ0ZXJSZWRpcmVjdHM7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5jdXJyZW50VXJsID0gZXZlbnQudXJsO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgXG4gICAgdGhpcy5hZG1pbkludGVyZmFjZSA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2FkbWluSW50ZXJmYWNlJykpO1xuICB9XG5cbiAgaXNBdXRob3JpemVkKCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGF1dGhSZWNvcmQgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdtZGRzLWF1dGgtcmVjb3JkJykpO1xuICAgIGlmIChhdXRoUmVjb3JkICYmIGF1dGhSZWNvcmRbJ2FjY2Vzc1Rva2VuJ10pIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIGdldExvZ291dFRpbWUoKTogbnVtYmVyIHtcbiAgICBjb25zdCBhdXRoUmVjb3JkID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnbWRkcy1hdXRoLXJlY29yZCcpKTtcbiAgICBpZiAoYXV0aFJlY29yZCAmJiAnbG9nb3V0VHMnIGluIGF1dGhSZWNvcmQpIHtcbiAgICAgICAgcmV0dXJuIGF1dGhSZWNvcmQubG9nb3V0VHM7XG4gICAgfVxuICAgIHJldHVybiAwO1xuICB9XG5cbiAgcHVibGljIGdldEFjY2Vzc1Rva2VuKCk6IHN0cmluZyB7XG4gICAgY29uc3QgYXV0aFJlY29yZCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ21kZHMtYXV0aC1yZWNvcmQnKSk7XG4gICAgaWYgKGF1dGhSZWNvcmQpIHtcbiAgICAgIHJldHVybiBhdXRoUmVjb3JkWydhY2Nlc3NUb2tlbiddO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHB1YmxpYyByZWZyZXNoVG9rZW4oKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBsZXQgYXV0aFJlY29yZDogYW55ID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnbWRkcy1hdXRoLXJlY29yZCcpKTtcbiAgICBpZiAoIWF1dGhSZWNvcmQpIHtcbiAgICAgIGF1dGhSZWNvcmQgPSB7cmVmcmVzaFRva2VuOiAnJywgdXNlck5hbWU6ICcnfTtcbiAgICB9XG4gICAgY29uc3QgcmVmcmVzaFRva2VuOiBzdHJpbmcgPSBhdXRoUmVjb3JkWydyZWZyZXNoVG9rZW4nXTtcbiAgICBjb25zdCB1c2VyTmFtZTogc3RyaW5nID0gYXV0aFJlY29yZFsndXNlck5hbWUnXTtcblxuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdDxhbnk+KFxuICAgICAgICB0aGlzLmF1dGhTZXJ2ZXJSb290VXJpICsgJy9yZWZyZXNoJyxcbiAgICAgICAge3JlZnJlc2hUb2tlbjogcmVmcmVzaFRva2VuLCB1c2VyTmFtZTogdXNlck5hbWV9XG4gICAgICApLnBpcGUoXG4gICAgICAgIG1hcCh0aGlzLmxvZ2dlZEluKSxcbiAgICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB7XG4gICAgICAgICAgdGhpcy5sb2dvdXQoKTtcbiAgICAgICAgICByZXR1cm4gZXJyb3I7XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHJlZnJlc2hTaG91bGRIYXBwZW4ocmVzcG9uc2U6IEh0dHBFcnJvclJlc3BvbnNlKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyA9PT0gNDAxO1xuICB9XG5cbiAgcHVibGljIHZlcmlmeVRva2VuUmVxdWVzdCh1cmw6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGlmICggdXJsLmVuZHNXaXRoKHRoaXMuYXV0aFNlcnZlclJvb3RVcmkgKyAnL3JlZnJlc2gnKSB8fFxuICAgICAgICB1cmwuZW5kc1dpdGgodGhpcy5hdXRoU2VydmVyUm9vdFVyaSArICcvbG9naW4nKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwdWJsaWMgZ2V0SW50ZXJydXB0ZWRVcmwoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5pbnRlcnJ1cHRlZFVybCB8fCAnLyc7XG4gIH1cblxuICBwdWJsaWMgZ2V0Um91dGVkRnJvbVVybCgpIHtcbiAgICByZXR1cm4gdGhpcy5yb3V0ZWRGcm9tVXJsIHx8ICcvJztcbiAgfVxuXG4gIHB1YmxpYyBzZXRJbnRlcnJ1cHRlZFVybCh1cmw6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuaW50ZXJydXB0ZWRVcmwgPSB1cmw7XG4gICAgY29uc3QgY3VycmVudFRpbWUgPSBEYXRlLm5vdygpO1xuXG4gICAgaWYgKCBjdXJyZW50VGltZSAtIHRoaXMubmF2aWdhdGVFbmRUaW1lID4gMTAwMCkge1xuICAgICAgLy8gSGFwcGVuZCA+IDEgc2VjLiBhc3N1bWUgaXQgaXMgdHJpZ2dlcmVkIGZyb20gY3VycmVudCBwYWdlLlxuICAgICAgdGhpcy5yb3V0ZWRGcm9tVXJsID0gdGhpcy5jdXJyZW50VXJsO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBwYWdlIHRyYW5zaXRpb25lZFxuICAgICAgdGhpcy5yb3V0ZWRGcm9tVXJsID0gdGhpcy5wcmV2aW91c1VybDtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ2V0VXNlck5hbWUoKTogc3RyaW5nIHtcbiAgICBsZXQgYXV0aFJlY29yZDogYW55ID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnbWRkcy1hdXRoLXJlY29yZCcpKTtcbiAgICBpZiAoIWF1dGhSZWNvcmQpIHtcbiAgICAgIGF1dGhSZWNvcmQgPSB7dXNlck5hbWU6ICcnfTtcbiAgICB9XG4gICAgcmV0dXJuIGF1dGhSZWNvcmRbJ3VzZXJOYW1lJ107XG4gIH1cblxuICBsb2dpbih1c2VyTmFtZTogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nKSB7XG4gICAgY29uc3QgYXV0aFJlY29yZDogYW55ID0ge1xuICAgICAgdXNlck5hbWU6IHVzZXJOYW1lLFxuICAgICAgYWNjZXNzVG9rZW46ICcnLFxuICAgICAgcmVmcmVzaFRva2VuOiAnJyxcbiAgICAgIGRpc3BsYXlOYW1lOiAnJ1xuICAgIH07XG4gICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ21kZHMtYXV0aC1yZWNvcmQnLCBKU09OLnN0cmluZ2lmeShhdXRoUmVjb3JkKSk7XG5cbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5hZG1pbkludGVyZmFjZSA/XG4gICAgICAgeyBwYXJhbXM6IG5ldyBIdHRwUGFyYW1zKCkuc2V0KCd0eXBlJywgJ2FkbWluJykgfSA6IHt9O1xuICAgIFxuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdDxhbnk+KHRoaXMuYXV0aFNlcnZlclJvb3RVcmkgKyAnL2xvZ2luJyxcbiAgICAgICAgeyB1c2VybmFtZTogdXNlck5hbWUsIHBhc3N3b3JkOiBwYXNzd29yZCB9LCBvcHRpb25zXG4gICAgICApLnBpcGUobWFwKHRoaXMubG9nZ2VkSW4pKTtcbiAgfVxuXG4gIHJlZ2lzdGVyKHVzZXJJbmZvOiBhbnkpIHtcbiAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgnbWRkcy1hdXRoLXJlY29yZCcpO1xuICAgIGNvbnN0IGF1dGhSZWNvcmQ6IGFueSA9IHtcbiAgICAgIHVzZXJOYW1lOiB1c2VySW5mby51c2VyTmFtZSxcbiAgICAgIGFjY2Vzc1Rva2VuOiAnJyxcbiAgICAgIHJlZnJlc2hUb2tlbjogJycsXG4gICAgICBkaXNwbGF5TmFtZTogdXNlckluZm8uZGlzcGxheU5hbWVcbiAgICB9O1xuICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdtZGRzLWF1dGgtcmVjb3JkJywgSlNPTi5zdHJpbmdpZnkoYXV0aFJlY29yZCkpO1xuICAgIFxuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLmFkbWluSW50ZXJmYWNlID9cbiAgICAgICB7IHBhcmFtczogbmV3IEh0dHBQYXJhbXMoKS5zZXQoJ3R5cGUnLCAnYWRtaW4nKSB9IDoge307XG5cbiAgICByZXR1cm4gdGhpcy5odHRwLnBvc3Q8YW55Pih0aGlzLmF1dGhTZXJ2ZXJSb290VXJpICsgJy9yZWdpc3RlcicsIHVzZXJJbmZvLCBvcHRpb25zKTtcbiAgfVxuXG4gIGxvZ2dlZEluKHVzZXIpIHtcbiAgICBjb25zdCBhdXRoUmVjb3JkOiBhbnkgPSB7XG4gICAgICB1c2VyTmFtZTogJycsXG4gICAgICBhY2Nlc3NUb2tlbjogJycsXG4gICAgICByZWZyZXNoVG9rZW46ICcnLFxuICAgICAgZGlzcGxheU5hbWU6ICcnXG4gICAgfTtcbiAgICBpZiAodXNlciAmJiB1c2VyLmFjY2Vzc1Rva2VuKSB7XG4gICAgICBhdXRoUmVjb3JkWydhY2Nlc3NUb2tlbiddID0gdXNlci5hY2Nlc3NUb2tlbjtcbiAgICB9XG4gICAgaWYgKHVzZXIgJiYgdXNlci5yZWZyZXNoVG9rZW4pIHtcbiAgICAgIGF1dGhSZWNvcmRbJ3JlZnJlc2hUb2tlbiddID0gdXNlci5yZWZyZXNoVG9rZW47XG4gICAgfVxuICAgIGlmICh1c2VyICYmIHVzZXIuZGlzcGxheU5hbWUpIHtcbiAgICAgIGF1dGhSZWNvcmRbJ2Rpc3BsYXlOYW1lJ10gPSB1c2VyLmRpc3BsYXlOYW1lO1xuICAgIH1cbiAgICBpZiAodXNlciAmJiB1c2VyLnVzZXJOYW1lKSB7XG4gICAgICBhdXRoUmVjb3JkWyd1c2VyTmFtZSddID0gdXNlci51c2VyTmFtZTtcbiAgICB9XG4gICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ21kZHMtYXV0aC1yZWNvcmQnLCBKU09OLnN0cmluZ2lmeShhdXRoUmVjb3JkKSk7XG4gICAgcmV0dXJuIHVzZXI7XG4gIH1cblxuICBsb2dvdXQoKSB7XG4gICAgLy8gcmVtb3ZlIHVzZXIgZnJvbSBsb2NhbCBzdG9yYWdlIHRvIGxvZyB1c2VyIG91dFxuICAgIGxldCBhdXRoUmVjb3JkID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnbWRkcy1hdXRoLXJlY29yZCcpKTtcbiAgICBpZiAoIWF1dGhSZWNvcmQpIHtcbiAgICAgICAgYXV0aFJlY29yZCA9IHt9O1xuICAgIH1cbiAgICBhdXRoUmVjb3JkLmxvZ291dFRzID0gRGF0ZS5ub3coKTtcbiAgICBhdXRoUmVjb3JkLmFjY2Vzc1Rva2VuID0gJyc7XG4gICAgYXV0aFJlY29yZC5yZWZyZXNoVG9rZW4gPSAnJztcbiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnbWRkcy1hdXRoLXJlY29yZCcsIEpTT04uc3RyaW5naWZ5KGF1dGhSZWNvcmQpKTtcbiAgfVxuICBcblxuICBzZXRBZG1pbkludGVyZmFjZShpc0FkbWluSW50ZXJmYWNlOiBib29sZWFuKTogdm9pZCB7XG4gICAgdGhpcy5hZG1pbkludGVyZmFjZSA9IGlzQWRtaW5JbnRlcmZhY2U7XG4gICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2FkbWluSW50ZXJmYWNlJywgSlNPTi5zdHJpbmdpZnkoaXNBZG1pbkludGVyZmFjZSkpO1xuICB9XG4gIFxuICBpc0FkbWluSW50ZXJmYWNlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmFkbWluSW50ZXJmYWNlO1xuICB9XG59XG4iXX0=