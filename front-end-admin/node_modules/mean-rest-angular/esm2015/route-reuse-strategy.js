/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/** @type {?} */
const COMPONENT_CACHE_DURATION = 30 * 1000;
export class MraRouteReuseStrategy {
    constructor() {
        this.detachedRouteHandles = {}; //key is url, and value is at [handle, timestamp] format
        //key is url, and value is at [handle, timestamp] format
        this.pageYOffset = {};
        this.editItems = {};
        this.isAuth = false;
    }
    /* Start: The following should use the authService. But let's decouple dependency now */
    /**
     * @private
     * @return {?}
     */
    isAuthorized() {
        //Refer to AuthenticationService for this function.
        /** @type {?} */
        const authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
        if (authRecord && authRecord.accessToken) {
            return true;
        }
        return false;
    }
    /**
     * @private
     * @return {?}
     */
    getLogoutTime() {
        /** @type {?} */
        const authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
        if (authRecord) {
            return authRecord.logoutTs;
        }
        return 0;
    }
    /* End */
    /**
     * @private
     * @return {?}
     */
    isLogoutReload() {
        if (this.isAuthorized()) {
            return false;
        }
        /** @type {?} */
        const currentTs = Date.now();
        /** @type {?} */
        const logoutTs = this.getLogoutTime();
        if (currentTs - logoutTs < 1000) {
            return true;
        }
        return false;
    }
    /**
     * @private
     * @return {?}
     */
    checkAuthentication() {
        /** @type {?} */
        const auth = this.isAuth;
        this.isAuth = this.isAuthorized();
        if (this.isAuth != auth) {
            // authentication status changed. Not attach;
            this.detachedRouteHandles = {}; // empty the map
        }
    }
    /**
     * Determines if this route (and its subtree) should be detached to be reused later
     * @param {?} route
     * @return {?}
     */
    shouldDetach(route) {
        if (route.routeConfig && route.routeConfig.path === 'list') {
            //save current scroll position
            /** @type {?} */
            let key = route['_routerState'].url;
            this.pageYOffset[key] = window.pageYOffset;
        }
        return route.routeConfig.path === 'list';
    }
    /**
     * Stores the detached route
     * @param {?} route
     * @param {?} handle
     * @return {?}
     */
    store(route, handle) {
        /** @type {?} */
        const date = new Date();
        /** @type {?} */
        const key = route['_routerState'].url;
        if (!handle)
            return;
        this.detachedRouteHandles[key] = [handle, date.getTime()];
    }
    /**
     * Determines if this route (and its subtree) should be reattached
     * @param {?} route
     * @return {?}
     */
    shouldAttach(route) {
        this.checkAuthentication();
        /** @type {?} */
        let date = new Date();
        /** @type {?} */
        let key = route['_routerState'].url;
        if (route.routeConfig && (route.routeConfig.path === 'new' || route.routeConfig.path === 'edit/:id')) {
            if (route.data && route.data.item) {
                this.editItems[route.data.item] = true;
            }
        }
        if (!route.routeConfig || route.routeConfig.path !== 'list') {
            return false;
        }
        if (!this.detachedRouteHandles[key]) {
            return false;
        }
        if (date.getTime() - this.detachedRouteHandles[key][1] > COMPONENT_CACHE_DURATION)
            return false;
        return true;
    }
    /**
     * Retrieves the previously stored route
     * @param {?} route
     * @return {?}
     */
    retrieve(route) {
        /** @type {?} */
        let date = new Date();
        /** @type {?} */
        let key = route['_routerState'].url;
        if (!route.routeConfig || route.routeConfig.path !== 'list')
            return null;
        if (route.data.item && (route.data.item in this.editItems)) {
            delete this.editItems[route.data.item];
            delete this.detachedRouteHandles[key];
            return null;
        }
        if (!this.detachedRouteHandles[key])
            return null;
        if (date.getTime() - this.detachedRouteHandles[key][1] > COMPONENT_CACHE_DURATION)
            return null;
        /** @type {?} */
        let yOffset = this.pageYOffset[key];
        setTimeout(function () {
            console.log("==retrieve: ", key, yOffset);
            window.scrollTo(0, yOffset);
        }, 20); //scroll to saved position
        return this.detachedRouteHandles[key][0];
    }
    /**
     * Determines if a route should be reused
     * @param {?} future
     * @param {?} curr
     * @return {?}
     */
    shouldReuseRoute(future, curr) {
        // Below is the default implementation;
        if (this.isLogoutReload()) {
            return false; // authentication status changed. Don't reuse.
        }
        return future.routeConfig === curr.routeConfig;
    }
}
if (false) {
    /** @type {?} */
    MraRouteReuseStrategy.prototype.detachedRouteHandles;
    /** @type {?} */
    MraRouteReuseStrategy.prototype.pageYOffset;
    /** @type {?} */
    MraRouteReuseStrategy.prototype.editItems;
    /** @type {?} */
    MraRouteReuseStrategy.prototype.isAuth;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGUtcmV1c2Utc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9tZWFuLXJlc3QtYW5ndWxhci8iLCJzb3VyY2VzIjpbInJvdXRlLXJldXNlLXN0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O01BRU0sd0JBQXdCLEdBQUcsRUFBRSxHQUFHLElBQUk7QUFDMUMsTUFBTSxPQUFPLHFCQUFxQjtJQUFsQztRQUVJLHlCQUFvQixHQUE2QixFQUFFLENBQUMsQ0FBQyx3REFBd0Q7O1FBQzdHLGdCQUFXLEdBQUcsRUFBRSxDQUFDO1FBQ2pCLGNBQVMsR0FBRyxFQUFFLENBQUM7UUFDZixXQUFNLEdBQUcsS0FBSyxDQUFDO0lBdUduQixDQUFDOzs7Ozs7SUFwR1csWUFBWTs7O2NBRVYsVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQ3ZFLElBQUksVUFBVSxJQUFJLFVBQVUsQ0FBQyxXQUFXLEVBQUc7WUFBQyxPQUFPLElBQUksQ0FBQztTQUFDO1FBQ3pELE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7Ozs7O0lBQ08sYUFBYTs7Y0FDWCxVQUFVLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDdkUsSUFBSSxVQUFVLEVBQUU7WUFDWixPQUFPLFVBQVUsQ0FBQyxRQUFRLENBQUM7U0FDOUI7UUFDRCxPQUFPLENBQUMsQ0FBQztJQUNiLENBQUM7Ozs7OztJQUdPLGNBQWM7UUFDbEIsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFLEVBQUU7WUFDckIsT0FBTyxLQUFLLENBQUM7U0FDaEI7O2NBQ0ssU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUU7O2NBQ3RCLFFBQVEsR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFO1FBQ3JDLElBQUksU0FBUyxHQUFHLFFBQVEsR0FBRyxJQUFJLEVBQUU7WUFD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aW1wb3J0IHsgQWN0aXZhdGVkUm91dGVTbmFwc2hvdCwgRGV0YWNoZWRSb3V0ZUhhbmRsZSwgUm91dGVSZXVzZVN0cmF0ZWd5IH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJ1xuXG5jb25zdCBDT01QT05FTlRfQ0FDSEVfRFVSQVRJT04gPSAzMCAqIDEwMDA7XG5leHBvcnQgY2xhc3MgTXJhUm91dGVSZXVzZVN0cmF0ZWd5IGltcGxlbWVudHMgUm91dGVSZXVzZVN0cmF0ZWd5IHtcblxuICAgIGRldGFjaGVkUm91dGVIYW5kbGVzOiB7IFtrZXk6IHN0cmluZ106IGFueVtdIH0gPSB7fTsgLy9rZXkgaXMgdXJsLCBhbmQgdmFsdWUgaXMgYXQgW2hhbmRsZSwgdGltZXN0YW1wXSBmb3JtYXRcbiAgICBwYWdlWU9mZnNldCA9IHt9O1xuICAgIGVkaXRJdGVtcyA9IHt9O1xuICAgIGlzQXV0aCA9IGZhbHNlO1xuXG4gICAgLyogU3RhcnQ6IFRoZSBmb2xsb3dpbmcgc2hvdWxkIHVzZSB0aGUgYXV0aFNlcnZpY2UuIEJ1dCBsZXQncyBkZWNvdXBsZSBkZXBlbmRlbmN5IG5vdyAqL1xuICAgIHByaXZhdGUgaXNBdXRob3JpemVkKCk6IGJvb2xlYW4ge1xuICAgICAgICAvL1JlZmVyIHRvIEF1dGhlbnRpY2F0aW9uU2VydmljZSBmb3IgdGhpcyBmdW5jdGlvbi5cbiAgICAgICAgY29uc3QgYXV0aFJlY29yZCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ21kZHMtYXV0aC1yZWNvcmQnKSk7XG4gICAgICAgIGlmIChhdXRoUmVjb3JkICYmIGF1dGhSZWNvcmQuYWNjZXNzVG9rZW4gKSB7cmV0dXJuIHRydWU7fVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHByaXZhdGUgZ2V0TG9nb3V0VGltZSgpOiBudW1iZXIge1xuICAgICAgICBjb25zdCBhdXRoUmVjb3JkID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnbWRkcy1hdXRoLXJlY29yZCcpKTtcbiAgICAgICAgaWYgKGF1dGhSZWNvcmQpIHsgXG4gICAgICAgICAgICByZXR1cm4gYXV0aFJlY29yZC5sb2dvdXRUcztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gMDtcbiAgICB9XG4gICAgLyogRW5kICovXG5cbiAgICBwcml2YXRlIGlzTG9nb3V0UmVsb2FkKCk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAodGhpcy5pc0F1dGhvcml6ZWQoKSkgeyBcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjdXJyZW50VHMgPSBEYXRlLm5vdygpO1xuICAgICAgICBjb25zdCBsb2dvdXRUcyA9IHRoaXMuZ2V0TG9nb3V0VGltZSgpO1xuICAgICAgICBpZiAoY3VycmVudFRzIC0gbG9nb3V0VHMgPCAxMDAwKSB7IFxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2hlY2tBdXRoZW50aWNhdGlvbigpIHtcbiAgICAgICAgY29uc3QgYXV0aCA9IHRoaXMuaXNBdXRoO1xuICAgICAgICB0aGlzLmlzQXV0aCA9IHRoaXMuaXNBdXRob3JpemVkKCk7XG4gICAgICAgIGlmICh0aGlzLmlzQXV0aCAhPSBhdXRoKSB7IFxuICAgICAgICAgICAgLy8gYXV0aGVudGljYXRpb24gc3RhdHVzIGNoYW5nZWQuIE5vdCBhdHRhY2g7XG4gICAgICAgICAgICB0aGlzLmRldGFjaGVkUm91dGVIYW5kbGVzID0ge307IC8vIGVtcHR5IHRoZSBtYXBcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKiBEZXRlcm1pbmVzIGlmIHRoaXMgcm91dGUgKGFuZCBpdHMgc3VidHJlZSkgc2hvdWxkIGJlIGRldGFjaGVkIHRvIGJlIHJldXNlZCBsYXRlciAqL1xuICAgIHB1YmxpYyBzaG91bGREZXRhY2gocm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHJvdXRlLnJvdXRlQ29uZmlnICYmIHJvdXRlLnJvdXRlQ29uZmlnLnBhdGggPT09ICdsaXN0Jykge1xuICAgICAgICAgICAgLy9zYXZlIGN1cnJlbnQgc2Nyb2xsIHBvc2l0aW9uXG4gICAgICAgICAgICBsZXQga2V5ID0gcm91dGVbJ19yb3V0ZXJTdGF0ZSddLnVybDtcbiAgICAgICAgICAgIHRoaXMucGFnZVlPZmZzZXRba2V5XSA9IHdpbmRvdy5wYWdlWU9mZnNldDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcm91dGUucm91dGVDb25maWcucGF0aCA9PT0gJ2xpc3QnO1xuICAgIH1cblxuICAgIC8qKiBTdG9yZXMgdGhlIGRldGFjaGVkIHJvdXRlICovXG4gICAgcHVibGljIHN0b3JlKHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LCBoYW5kbGU6IERldGFjaGVkUm91dGVIYW5kbGUpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKCk7XG4gICAgICAgIGNvbnN0IGtleSA9IHJvdXRlWydfcm91dGVyU3RhdGUnXS51cmw7XG4gICAgICAgIGlmICghaGFuZGxlKSByZXR1cm47XG4gICAgICAgIHRoaXMuZGV0YWNoZWRSb3V0ZUhhbmRsZXNba2V5XSA9IFtoYW5kbGUsIGRhdGUuZ2V0VGltZSgpXVxuICAgIH1cblxuICAgIC8qKiBEZXRlcm1pbmVzIGlmIHRoaXMgcm91dGUgKGFuZCBpdHMgc3VidHJlZSkgc2hvdWxkIGJlIHJlYXR0YWNoZWQgKi9cbiAgICBwdWJsaWMgc2hvdWxkQXR0YWNoKHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogYm9vbGVhbiB7XG4gICAgICAgIHRoaXMuY2hlY2tBdXRoZW50aWNhdGlvbigpO1xuICAgICAgICBsZXQgZGF0ZSA9IG5ldyBEYXRlKCk7XG4gICAgICAgIGxldCBrZXkgPSByb3V0ZVsnX3JvdXRlclN0YXRlJ10udXJsO1xuICAgICAgICBpZiAocm91dGUucm91dGVDb25maWcgJiYgKHJvdXRlLnJvdXRlQ29uZmlnLnBhdGggPT09ICduZXcnIHx8IHJvdXRlLnJvdXRlQ29uZmlnLnBhdGggPT09ICdlZGl0LzppZCcpKSB7XG4gICAgICAgICAgICBpZiAocm91dGUuZGF0YSAmJiByb3V0ZS5kYXRhLml0ZW0pIHsgXG4gICAgICAgICAgICAgICAgdGhpcy5lZGl0SXRlbXNbcm91dGUuZGF0YS5pdGVtXSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFyb3V0ZS5yb3V0ZUNvbmZpZyB8fCByb3V0ZS5yb3V0ZUNvbmZpZy5wYXRoICE9PSAnbGlzdCcpIHsgIHJldHVybiBmYWxzZTsgfVxuICAgICAgICBpZiAoIXRoaXMuZGV0YWNoZWRSb3V0ZUhhbmRsZXNba2V5XSkgeyByZXR1cm4gZmFsc2U7IH1cbiAgICAgICAgaWYgKGRhdGUuZ2V0VGltZSgpIC0gdGhpcy5kZXRhY2hlZFJvdXRlSGFuZGxlc1trZXldWzFdICA+IENPTVBPTkVOVF9DQUNIRV9EVVJBVElPTikgIHJldHVybiBmYWxzZTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLyoqIFJldHJpZXZlcyB0aGUgcHJldmlvdXNseSBzdG9yZWQgcm91dGUgKi9cbiAgICBwdWJsaWMgcmV0cmlldmUocm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QpOiBEZXRhY2hlZFJvdXRlSGFuZGxlIHtcbiAgICAgICAgbGV0IGRhdGUgPSBuZXcgRGF0ZSgpO1xuICAgICAgICBsZXQga2V5ID0gcm91dGVbJ19yb3V0ZXJTdGF0ZSddLnVybDtcbiAgICAgICAgaWYgKCFyb3V0ZS5yb3V0ZUNvbmZpZyB8fCByb3V0ZS5yb3V0ZUNvbmZpZy5wYXRoICE9PSAnbGlzdCcpIHJldHVybiBudWxsO1xuICAgICAgICBpZiAocm91dGUuZGF0YS5pdGVtICYmIChyb3V0ZS5kYXRhLml0ZW0gaW4gdGhpcy5lZGl0SXRlbXMpKSB7XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5lZGl0SXRlbXNbcm91dGUuZGF0YS5pdGVtXTtcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmRldGFjaGVkUm91dGVIYW5kbGVzW2tleV07XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMuZGV0YWNoZWRSb3V0ZUhhbmRsZXNba2V5XSkgcmV0dXJuIG51bGw7XG4gICAgICAgIGlmIChkYXRlLmdldFRpbWUoKSAtIHRoaXMuZGV0YWNoZWRSb3V0ZUhhbmRsZXNba2V5XVsxXSAgPiBDT01QT05FTlRfQ0FDSEVfRFVSQVRJT04pIHJldHVybiBudWxsO1xuICAgICAgICBcbiAgICAgICAgbGV0IHlPZmZzZXQgPSB0aGlzLnBhZ2VZT2Zmc2V0W2tleV07XG4gICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiPT1yZXRyaWV2ZTogXCIsIGtleSwgeU9mZnNldCk7XG4gICAgICAgICAgICAgICAgd2luZG93LnNjcm9sbFRvKDAsIHlPZmZzZXQpO1xuICAgICAgICAgICAgfSwgMjApOyAvL3Njcm9sbCB0byBzYXZlZCBwb3NpdGlvblxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHRoaXMuZGV0YWNoZWRSb3V0ZUhhbmRsZXNba2V5XVswXTtcbiAgICB9XG5cbiAgICAvKiogRGV0ZXJtaW5lcyBpZiBhIHJvdXRlIHNob3VsZCBiZSByZXVzZWQgKi9cbiAgICBwdWJsaWMgc2hvdWxkUmV1c2VSb3V0ZShmdXR1cmU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QsIGN1cnI6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QpOiBib29sZWFuIHtcbiAgICAgICAgLy8gQmVsb3cgaXMgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb247XG4gICAgICAgIGlmICh0aGlzLmlzTG9nb3V0UmVsb2FkKCkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gYXV0aGVudGljYXRpb24gc3RhdHVzIGNoYW5nZWQuIERvbid0IHJldXNlLlxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmdXR1cmUucm91dGVDb25maWcgPT09IGN1cnIucm91dGVDb25maWdcbiAgICB9XG59XG4iXX0=