import { CommonModule } from '@angular/common';
import { FormBuilder, Validators, FormsModule, ReactiveFormsModule } from '@angular/forms';
import { HttpClient, HttpParams, HttpErrorResponse, HttpClientModule, HTTP_INTERCEPTORS } from '@angular/common/http';
import { BehaviorSubject, throwError, EMPTY } from 'rxjs';
import { catchError, map, first, switchMap, filter, take } from 'rxjs/operators';
import { Router, NavigationEnd, ActivatedRoute, RouterModule } from '@angular/router';
import { InjectionToken, Injectable, Inject, Component, NgModule, Directive, EventEmitter, ElementRef, HostListener, Output } from '@angular/core';

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/** @type {?} */
const AUTHTICATION_SERVER_ROOT_URI = new InjectionToken('AUTHTICATION_SERVER_ROOT_URI');
/** @type {?} */
const AUTHTICATION_LOGIN_PAGE_URI = new InjectionToken('AUTHTICATION_LOGIN_PAGE_URI');
/** @type {?} */
const AUTHTICATION_INTERFACES = new InjectionToken('AUTHTICATION_INTERFACES');

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
class AuthenticationService {
    /**
     * @param {?} authServerRootUri
     * @param {?} router
     * @param {?} http
     */
    constructor(authServerRootUri, router, http) {
        this.authServerRootUri = authServerRootUri;
        this.router = router;
        this.http = http;
        this.adminInterface = false;
        this.navigateEndTime = Date.now();
        router.events.subscribe(event => {
            if (event instanceof NavigationEnd) {
                this.previousUrl = this.currentUrl;
                this.navigateEndTime = Date.now();
                if (event.urlAfterRedirects) {
                    this.currentUrl = event.urlAfterRedirects;
                }
                else {
                    this.currentUrl = event.url;
                }
            }
        });
        this.adminInterface = JSON.parse(localStorage.getItem('adminInterface'));
    }
    /**
     * @return {?}
     */
    isAuthorized() {
        /** @type {?} */
        const authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
        if (authRecord && authRecord['accessToken']) {
            return true;
        }
        return false;
    }
    /**
     * @private
     * @return {?}
     */
    getLogoutTime() {
        /** @type {?} */
        const authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
        if (authRecord && 'logoutTs' in authRecord) {
            return authRecord.logoutTs;
        }
        return 0;
    }
    /**
     * @return {?}
     */
    getAccessToken() {
        /** @type {?} */
        const authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
        if (authRecord) {
            return authRecord['accessToken'];
        }
        return null;
    }
    /**
     * @return {?}
     */
    refreshToken() {
        /** @type {?} */
        let authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
        if (!authRecord) {
            authRecord = { refreshToken: '', userName: '' };
        }
        /** @type {?} */
        const refreshToken = authRecord['refreshToken'];
        /** @type {?} */
        const userName = authRecord['userName'];
        return this.http.post(this.authServerRootUri + '/refresh', { refreshToken: refreshToken, userName: userName }).pipe(map(this.loggedIn), catchError(error => {
            this.logout();
            return error;
        }));
    }
    /**
     * @param {?} response
     * @return {?}
     */
    refreshShouldHappen(response) {
        return response.status === 401;
    }
    /**
     * @param {?} url
     * @return {?}
     */
    verifyTokenRequest(url) {
        if (url.endsWith(this.authServerRootUri + '/refresh') ||
            url.endsWith(this.authServerRootUri + '/login')) {
            return true;
        }
        return false;
    }
    /**
     * @return {?}
     */
    getInterruptedUrl() {
        return this.interruptedUrl || '/';
    }
    /**
     * @return {?}
     */
    getRoutedFromUrl() {
        return this.routedFromUrl || '/';
    }
    /**
     * @param {?} url
     * @return {?}
     */
    setInterruptedUrl(url) {
        this.interruptedUrl = url;
        /** @type {?} */
        const currentTime = Date.now();
        if (currentTime - this.navigateEndTime > 1000) {
            // Happend > 1 sec. assume it is triggered from current page.
            this.routedFromUrl = this.currentUrl;
        }
        else {
            // page transitioned
            this.routedFromUrl = this.previousUrl;
        }
    }
    /**
     * @return {?}
     */
    getUserName() {
        /** @type {?} */
        let authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
        if (!authRecord) {
            authRecord = { userName: '' };
        }
        return authRecord['userName'];
    }
    /**
     * @param {?} userName
     * @param {?} password
     * @return {?}
     */
    login(userName, password) {
        /** @type {?} */
        const authRecord = {
            userName: userName,
            accessToken: '',
            refreshToken: '',
            displayName: ''
        };
        localStorage.setItem('mdds-auth-record', JSON.stringify(authRecord));
        /** @type {?} */
        const options = this.adminInterface ?
            { params: new HttpParams().set('type', 'admin') } : {};
        return this.http.post(this.authServerRootUri + '/login', { username: userName, password: password }, options).pipe(map(this.loggedIn));
    }
    /**
     * @param {?} userInfo
     * @return {?}
     */
    register(userInfo) {
        localStorage.removeItem('mdds-auth-record');
        /** @type {?} */
        const authRecord = {
            userName: userInfo.userName,
            accessToken: '',
            refreshToken: '',
            displayName: userInfo.displayName
        };
        localStorage.setItem('mdds-auth-record', JSON.stringify(authRecord));
        /** @type {?} */
        const options = this.adminInterface ?
            { params: new HttpParams().set('type', 'admin') } : {};
        return this.http.post(this.authServerRootUri + '/register', userInfo, options);
    }
    /**
     * @param {?} user
     * @return {?}
     */
    loggedIn(user) {
        /** @type {?} */
        const authRecord = {
            userName: '',
            accessToken: '',
            refreshToken: '',
            displayName: ''
        };
        if (user && user.accessToken) {
            authRecord['accessToken'] = user.accessToken;
        }
        if (user && user.refreshToken) {
            authRecord['refreshToken'] = user.refreshToken;
        }
        if (user && user.displayName) {
            authRecord['displayName'] = user.displayName;
        }
        if (user && user.userName) {
            authRecord['userName'] = user.userName;
        }
        localStorage.setItem('mdds-auth-record', JSON.stringify(authRecord));
        return user;
    }
    /**
     * @return {?}
     */
    logout() {
        // remove user from local storage to log user out
        /** @type {?} */
        let authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
        if (!authRecord) {
            authRecord = {};
        }
        authRecord.logoutTs = Date.now();
        authRecord.accessToken = '';
        authRecord.refreshToken = '';
        localStorage.setItem('mdds-auth-record', JSON.stringify(authRecord));
    }
    /**
     * @param {?} isAdminInterface
     * @return {?}
     */
    setAdminInterface(isAdminInterface) {
        this.adminInterface = isAdminInterface;
        localStorage.setItem('adminInterface', JSON.stringify(isAdminInterface));
    }
    /**
     * @return {?}
     */
    isAdminInterface() {
        return this.adminInterface;
    }
}
AuthenticationService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
AuthenticationService.ctorParameters = () => [
    { type: String, decorators: [{ type: Inject, args: [AUTHTICATION_SERVER_ROOT_URI,] }] },
    { type: Router },
    { type: HttpClient }
];

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
class AuthGuard {
    /**
     * @param {?} router
     * @param {?} authService
     * @param {?} loginPageUri
     */
    constructor(router, authService, loginPageUri) {
        this.router = router;
        this.authService = authService;
        this.loginPageUri = loginPageUri;
    }
    /**
     * @param {?} route
     * @param {?} state
     * @return {?}
     */
    canActivate(route, state) {
        if (this.authService.isAuthorized()) {
            // logged in so return true
            return true;
        }
        // not logged in so redirect to login page with the return url
        this.authService.setInterruptedUrl(state.url);
        this.router.navigate([this.loginPageUri]);
        return false;
    }
    /**
     * @param {?} route
     * @param {?} state
     * @return {?}
     */
    canActivateChild(route, state) {
        return this.canActivate(route, state);
    }
}
AuthGuard.decorators = [
    { type: Injectable }
];
/** @nocollapse */
AuthGuard.ctorParameters = () => [
    { type: Router },
    { type: AuthenticationService },
    { type: String, decorators: [{ type: Inject, args: [AUTHTICATION_LOGIN_PAGE_URI,] }] }
];

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
class AuthenticationComponent {
    /**
     * @param {?} authenticationService
     * @param {?} authenticationInterfaces
     */
    constructor(authenticationService, authenticationInterfaces) {
        this.authenticationService = authenticationService;
        this.authenticationInterfaces = authenticationInterfaces;
        this.adminInterface = false;
        this.userIntEnabled = false;
        this.adminIntEnabled = false;
        /** @type {?} */
        let str = authenticationInterfaces.toLowerCase();
        if (str.includes("user") && str.includes("admin")) { //both interface. Check cached.
            this.adminInterface = authenticationService.isAdminInterface();
            this.userIntEnabled = true;
            this.adminIntEnabled = true;
        }
        else if (str.includes("admin")) { //administrator only
            this.authenticationService.setAdminInterface(true);
            this.adminIntEnabled = true;
        }
        else { //users only
            this.authenticationService.setAdminInterface(false);
            this.userIntEnabled = true;
        }
    }
    /**
     * @param {?} adminInterface
     * @return {?}
     */
    setAdminInterface(adminInterface) {
        this.adminInterface = adminInterface;
        this.authenticationService.setAdminInterface(this.adminInterface);
    }
}
AuthenticationComponent.decorators = [
    { type: Component, args: [{
                selector: 'app-auth',
                template: "<div class=\"container\">\n    <div class=\"row mt-5\">\n        <div class=\"col-md-6 offset-md-3\">\n            <router-outlet></router-outlet>\n        </div>\n    </div>\n</div>\n"
            }] }
];
/** @nocollapse */
AuthenticationComponent.ctorParameters = () => [
    { type: AuthenticationService },
    { type: String, decorators: [{ type: Inject, args: [AUTHTICATION_INTERFACES,] }] }
];

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
class LoginComponent {
    /**
     * @param {?} formBuilder
     * @param {?} route
     * @param {?} router
     * @param {?} authenticationService
     */
    constructor(formBuilder, route, router, authenticationService) {
        this.formBuilder = formBuilder;
        this.route = route;
        this.router = router;
        this.authenticationService = authenticationService;
        this.loading = false;
        this.submitted = false;
        this.servererror = false;
        this.serverText = '';
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.loginForm = this.formBuilder.group({
            username: ['', Validators.required],
            password: ['', Validators.required]
        });
        // reset login status
        this.authenticationService.logout();
        // get return url from route parameters or default to '/'
        // this.returnUrl = this.route.snapshot.queryParams['returnUrl'] || '/';
    }
    // convenience getter for easy access to form fields
    /**
     * @return {?}
     */
    get f() { return this.loginForm.controls; }
    /**
     * @return {?}
     */
    onSubmit() {
        this.submitted = true;
        // stop here if form is invalid
        if (this.loginForm.invalid) {
            return;
        }
        /** @type {?} */
        let returnUrl = this.authenticationService.getInterruptedUrl();
        if (this.router.url === returnUrl) {
            returnUrl = '/';
        } // home page
        this.loading = true;
        this.authenticationService.login(this.f.username.value, this.f.password.value)
            .pipe(first())
            .subscribe(data => {
            this.servererror = false;
            this.router.navigate([returnUrl]);
            this.loading = false;
        }, error => {
            // this.alertService.error(error);
            this.servererror = true;
            this.serverText = error.error.error;
            this.loading = false;
        });
    }
    /**
     * @return {?}
     */
    cancel() {
        /** @type {?} */
        const routedFromUrl = this.authenticationService.getRoutedFromUrl();
        this.router.navigate([routedFromUrl]);
    }
}
LoginComponent.decorators = [
    { type: Component, args: [{ template: "<h2>Login</h2>\n<form [formGroup]=\"loginForm\" (ngSubmit)=\"onSubmit()\">\n    <div class=\"form-group\">\n        <label for=\"username\">Username</label>\n        <input type=\"text\" formControlName=\"username\" class=\"form-control\" [ngClass]=\"{ 'is-invalid': submitted && f.username.errors }\" />\n        <div *ngIf=\"submitted && f.username.errors\" class=\"invalid-feedback\">\n            <div *ngIf=\"f.username.errors.required\">Username is required</div>\n        </div>\n    </div>\n    <div class=\"form-group\">\n        <label for=\"password\">Password</label>\n        <input type=\"password\" formControlName=\"password\" class=\"form-control\" [ngClass]=\"{ 'is-invalid': submitted && f.password.errors }\" />\n        <div *ngIf=\"submitted && f.password.errors\" class=\"invalid-feedback\">\n            <div *ngIf=\"f.password.errors.required\">Password is required</div>\n        </div>\n    </div>\n    <div class=\"form-group\">\n        <button [disabled]=\"loading\" class=\"btn btn-primary\" (click)=\"onSubmit();\">Login</button>\n        <img *ngIf=\"loading\" src=\"data:image/gif;base64,R0lGODlhEAAQAPIAAP///wAAAMLCwkJCQgAAAGJiYoKCgpKSkiH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAADMwi63P4wyklrE2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQJCgAAACwAAAAAEAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUkKhIAIfkECQoAAAAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkECQoAAAAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYumCYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkECQoAAAAsAAAAABAAEAAAAzIIunInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQJCgAAACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJibufbSlKAAAh+QQJCgAAACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFGxTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAkKAAAALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdceCAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA==\" />\n        <a [routerLink]=\"['../register']\" class=\"btn btn-link\">Register</a>\n        <button type=\"button\" (click)=\"cancel()\" class=\"btn btn-link float-right\">Cancel</button>\n    </div>\n    <div *ngIf=\"servererror\" style=\"display: block;\" class=\"invalid-feedback\">\n  \t\t{{serverText}}\n    </div>\n</form>", styles: [""] }] }
];
/** @nocollapse */
LoginComponent.ctorParameters = () => [
    { type: FormBuilder },
    { type: ActivatedRoute },
    { type: Router },
    { type: AuthenticationService }
];

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/** @type {?} */
const validatePasswords = function (form) {
    /** @type {?} */
    const passwordConf = form.controls.password_conf.value;
    /** @type {?} */
    const password = form.controls.password.value;
    if (passwordConf === password) {
        return null;
    }
    else {
        form.controls.password_conf.setErrors({ 'passwordNotSame': true });
        return null;
    }
};
class RegisterComponent {
    /**
     * @param {?} formBuilder
     * @param {?} router
     * @param {?} route
     * @param {?} authenticationService
     */
    constructor(formBuilder, router, route, authenticationService) {
        this.formBuilder = formBuilder;
        this.router = router;
        this.route = route;
        this.authenticationService = authenticationService;
        this.loading = false;
        this.submitted = false;
        this.servererror = false;
        this.serverText = '';
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.registerForm = this.formBuilder.group({
            username: ['', Validators.required],
            password: ['', [Validators.required, Validators.minLength(6)]],
            password_conf: ['', [Validators.required, Validators.minLength(6)]]
        }, { validator: validatePasswords });
    }
    // convenience getter for easy access to form fields
    /**
     * @return {?}
     */
    get f() { return this.registerForm.controls; }
    /**
     * @return {?}
     */
    onSubmit() {
        this.submitted = true;
        // stop here if form is invalid
        if (this.registerForm.invalid) {
            return;
        }
        this.loading = true;
        this.authenticationService.register(this.registerForm.value)
            .pipe(first())
            .subscribe(data => {
            // this.alertService.success('Registration successful', true);
            this.router.navigate(['../login'], { relativeTo: this.route, });
            this.servererror = false;
        }, error => {
            // this.alertService.error(error);
            // alert("Error login");
            this.servererror = true;
            this.serverText = error.error.error;
            this.loading = false;
        });
    }
    /**
     * @return {?}
     */
    cancel() {
        /** @type {?} */
        const routedFromUrl = this.authenticationService.getRoutedFromUrl();
        this.router.navigate([routedFromUrl]);
    }
}
RegisterComponent.decorators = [
    { type: Component, args: [{ template: "<h2>Register</h2>\n<form [formGroup]=\"registerForm\" (ngSubmit)=\"onSubmit()\">\n    <div class=\"form-group\">\n        <label for=\"username\">Username</label>\n        <input type=\"text\" formControlName=\"username\" class=\"form-control\" [ngClass]=\"{ 'is-invalid': submitted && f.username.errors }\" />\n        <div *ngIf=\"submitted && f.username.errors\" class=\"invalid-feedback\">\n            <div *ngIf=\"f.username.errors.required\">Username is required</div>\n        </div>\n    </div>\n    <div class=\"form-group\">\n        <label for=\"password\">Password</label>\n        <input type=\"password\" formControlName=\"password\" class=\"form-control\" [ngClass]=\"{ 'is-invalid': submitted && f.password.errors }\" />\n        <div *ngIf=\"submitted && f.password.errors\" class=\"invalid-feedback\">\n            <div *ngIf=\"f.password.errors.required\">Password is required</div>\n            <div *ngIf=\"f.password.errors.minlength\">Password must be at least 6 characters</div>\n        </div>\n    </div>\n    <div class=\"form-group\">\n        <label for=\"password_conf\">Confirm Password</label>\n        <input type=\"password\" formControlName=\"password_conf\" class=\"form-control\" [ngClass]=\"{ 'is-invalid': submitted && f.password_conf.errors }\" />\n        <div *ngIf=\"submitted && f.password_conf.errors\" class=\"invalid-feedback\">\n            <div *ngIf=\"f.password_conf.errors.required\">Password is required</div>\n            <div *ngIf=\"f.password_conf.errors.minlength\">Password must be at least 6 characters</div>\n            <div *ngIf=\"f.password_conf.errors.passwordNotSame\">Password doesn't match.</div>\n        </div>\n    </div>\n    <div class=\"form-group\">\n        <button [disabled]=\"loading\" class=\"btn btn-primary\">Register</button>\n        <img *ngIf=\"loading\" src=\"data:image/gif;base64,R0lGODlhEAAQAPIAAP///wAAAMLCwkJCQgAAAGJiYoKCgpKSkiH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAADMwi63P4wyklrE2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQJCgAAACwAAAAAEAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUkKhIAIfkECQoAAAAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkECQoAAAAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYumCYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkECQoAAAAsAAAAABAAEAAAAzIIunInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQJCgAAACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJibufbSlKAAAh+QQJCgAAACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFGxTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAkKAAAALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdceCAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA==\" />\n\n        <a [routerLink]=\"['../login']\" class=\"btn btn-link\">Login</a>\n        <button (click)=\"cancel()\" class=\"btn btn-link float-right\">Cancel</button>\n    </div>\n    <div *ngIf=\"servererror\" style=\"display: block;\" class=\"invalid-feedback\">\n  \t\t{{serverText}}\n    </div>\n</form>\n", styles: [".invalid-feedback{width:100%;margin-top:.25rem;font-size:80%;color:#dc3545}"] }] }
];
/** @nocollapse */
RegisterComponent.ctorParameters = () => [
    { type: FormBuilder },
    { type: Router },
    { type: ActivatedRoute },
    { type: AuthenticationService }
];

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/** @type {?} */
const routes = [
    { path: 'auth',
        component: AuthenticationComponent,
        children: [
            { path: "login", component: LoginComponent },
            { path: 'register', component: RegisterComponent },
            { path: '', redirectTo: 'login', pathMatch: 'full' },
            { path: '**', redirectTo: 'login' }
        ]
    }
];
class AuthRoutingModule {
}
AuthRoutingModule.decorators = [
    { type: NgModule, args: [{
                imports: [RouterModule.forChild(routes)],
                exports: [RouterModule]
            },] }
];

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
class TokenInterceptor {
    /**
     * @param {?} router
     * @param {?} authService
     * @param {?} loginPageUri
     */
    constructor(router, authService, loginPageUri) {
        this.router = router;
        this.authService = authService;
        this.loginPageUri = loginPageUri;
        this.refreshTokenInProgress = false;
        // Refresh Token Subject tracks the current token, or is null if no token is currently
        // available (e.g. refresh pending).
        this.refreshTokenSubject = new BehaviorSubject(null);
    }
    /**
     * @param {?} request
     * @return {?}
     */
    addAuthHeader(request) {
        if (this.authService.isAuthorized()) {
            request = request.clone({
                setHeaders: {
                    Authorization: `Bearer ${this.authService.getAccessToken()}`
                }
            });
        }
        return request;
    }
    /**
     * @param {?} request
     * @param {?} next
     * @return {?}
     */
    intercept(request, next) {
        return next.handle(this.addAuthHeader(request))
            .pipe(
        /*
        tap((event: HttpEvent<any>) => {
            if (event instanceof HttpResponse) {
              ;
            }
          }, (err: any) => {
            if (err instanceof HttpErrorResponse) {
              if (err.status === 401) {
                this.authService.setInterruptedUrl(this.router.url);
                this.router.navigate([this.loginPageUri]);
              }
            }
        })
        */
        catchError((error) => {
            if (error instanceof HttpErrorResponse && error.status === 401) {
                if (this.refreshTokenInProgress && !this.authService.verifyTokenRequest(request.url)) {
                    // If refreshTokenInProgress is true, we will wait until refreshTokenSubject has a non-null value
                    // – which means the new token is ready and we can retry the request again
                    return this.refreshTokenSubject.pipe(filter(result => result !== null), take(1), switchMap(() => next.handle(this.addAuthHeader(request))));
                }
                else {
                    this.refreshTokenInProgress = true;
                    // Set the refreshTokenSubject to null so that subsequent API calls will wait until the new token has been retrieved
                    this.refreshTokenSubject.next(null);
                    return this.authService.refreshToken().pipe(switchMap((data) => {
                        this.refreshTokenInProgress = false;
                        this.refreshTokenSubject.next(data);
                        return next.handle(this.addAuthHeader(request));
                    }), catchError((err) => {
                        // looks like this part will not hit
                        this.refreshTokenInProgress = false;
                        this.authService.setInterruptedUrl(this.router.url);
                        this.router.navigate([this.loginPageUri]);
                        return EMPTY;
                    }));
                }
            }
            if (this.authService.verifyTokenRequest(request.url)) {
                // refreshToken failed. Go to login page.
                this.refreshTokenInProgress = false;
                this.authService.setInterruptedUrl(this.router.url);
                this.router.navigate([this.loginPageUri]);
            }
            return throwError(error);
        }));
    }
}
TokenInterceptor.decorators = [
    { type: Injectable }
];
/** @nocollapse */
TokenInterceptor.ctorParameters = () => [
    { type: Router },
    { type: AuthenticationService },
    { type: String, decorators: [{ type: Inject, args: [AUTHTICATION_LOGIN_PAGE_URI,] }] }
];

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
class AuthIconComponent {
    /**
     * @param {?} router
     * @param {?} authService
     * @param {?} loginPageUri
     */
    constructor(router, authService, loginPageUri) {
        this.router = router;
        this.authService = authService;
        this.loginPageUri = loginPageUri;
        this.popup = false;
        this.popupStyle = {};
        this.userName = 'Please login';
        this.userNameShort = 'Please login';
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.isAuthorized();
    }
    /**
     * @param {?} event
     * @return {?}
     */
    toggle(event) {
        if (!this.popup) {
            /** @type {?} */
            const right = (window.innerWidth - event.x) - 2;
            /** @type {?} */
            const top = event.y + 15;
            this.popupStyle = {
                'right': right.toString() + 'px',
                'top': top.toString() + 'px',
            };
        }
        this.popup = !this.popup;
    }
    /**
     * @return {?}
     */
    closePopup() {
        this.popup = false;
    }
    /**
     * @return {?}
     */
    isAuthorized() {
        /** @type {?} */
        const name = this.authService.getUserName();
        /** @type {?} */
        const isAuth = this.authService.isAuthorized();
        if (name) {
            this.userName = name;
            if (isAuth) {
                if (name.length > 12) {
                    this.userNameShort = name.substring(0, 10) + '...';
                }
                else {
                    this.userNameShort = name.substring(0, 13);
                }
            }
            else {
                this.userNameShort = 'Please login';
            }
        }
        return isAuth;
    }
    /**
     * @return {?}
     */
    login() {
        // not logged in so redirect to login page with the return url
        /** @type {?} */
        const state = this.router.routerState.snapshot;
        this.authService.setInterruptedUrl(state.url);
        this.popup = false;
        this.router.navigate([this.loginPageUri]);
    }
    /**
     * @return {?}
     */
    logout() {
        // not logged in so redirect to login page with the return url
        this.authService.logout();
        this.popup = false;
        this.router.navigated = false; // refresh current page;
        this.router.navigate(['/']); // home page
    }
}
AuthIconComponent.decorators = [
    { type: Component, args: [{
                selector: 'app-auth-icon',
                template: "<div class='auth-icon-container' (clickElsewhere)=\"closePopup()\">\n\n\t<div class=\"auth-icon\" [ngClass]=\"{'auth-icon-active': isAuthorized()}\" (click)=\"toggle($event)\">\n\t\t<span class=\"icon-text\"><i class=\"fas fa-user\"></i></span>\n\t</div>\n\n    <div>{{userNameShort}}</div>\n\n\t<div *ngIf=\"popup\" class=\"auth-icon-pop\" [ngStyle]=\"popupStyle\">\n\t  <div class=\"dropdown-menu pop-menu-container\">\n\t  \t<label class=\"login-name\">{{userName}}</label>\n\t  \n\t  \t<div class=\"dropdown-divider\"></div>\n\t    <ng-container *ngIf=\"isAuthorized(); else notAuthorized\">\n\t\t    <a class=\"dropdown-item\" href=\"#\">Profile</a>\n\t\t    \n\t\t    <div class=\"dropdown-divider\"></div>\n\t\t    \n\t\t    <a class=\"dropdown-item btn\" (click)=\"logout()\">Logout</a>\n\t\t</ng-container>\n\t    <ng-template #notAuthorized>\t\t    \n\t\t    <a class=\"dropdown-item btn\" (click)=\"login()\">Login</a>\n\t\t</ng-template>\n\t  </div>\n    </div>\n</div>",
                styles: [".auth-icon{margin-left:auto;margin-right:auto;background-color:#aaa;height:2.5rem;width:2.5rem;border-radius:50%;text-align:center;cursor:pointer}.auth-icon-active{background-color:#5aa046}.icon-text{font-size:1.5rem;margin-top:.5rem}.auth-icon:hover{background-color:#c8c8c8}.auth-icon-active:hover{background-color:#78aa6e}.auth-icon-pop{position:absolute;z-index:10}.pop-menu-container{position:relative;display:block}.login-name{width:100%;font-style:italic;text-align:center}"]
            }] }
];
/** @nocollapse */
AuthIconComponent.ctorParameters = () => [
    { type: Router },
    { type: AuthenticationService },
    { type: String, decorators: [{ type: Inject, args: [AUTHTICATION_LOGIN_PAGE_URI,] }] }
];

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
class ClickElsewhereDirective {
    /**
     * @param {?} elementRef
     */
    constructor(elementRef) {
        this.elementRef = elementRef;
        this.clickElsewhere = new EventEmitter();
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onDocumentClick(event) {
        /** @type {?} */
        const targetElement = (/** @type {?} */ (event.target));
        // Check if the click was outside the element
        if (targetElement && !this.elementRef.nativeElement.contains(targetElement)) {
            this.clickElsewhere.emit(event);
        }
    }
}
ClickElsewhereDirective.decorators = [
    { type: Directive, args: [{ selector: '[clickElsewhere]' },] }
];
/** @nocollapse */
ClickElsewhereDirective.ctorParameters = () => [
    { type: ElementRef }
];
ClickElsewhereDirective.propDecorators = {
    clickElsewhere: [{ type: Output }],
    onDocumentClick: [{ type: HostListener, args: ['document:click', ['$event'],] }]
};

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
class AuthenticationModule {
}
AuthenticationModule.decorators = [
    { type: NgModule, args: [{
                imports: [
                    CommonModule,
                    FormsModule,
                    ReactiveFormsModule,
                    HttpClientModule,
                    AuthRoutingModule
                ],
                declarations: [
                    AuthenticationComponent,
                    LoginComponent,
                    RegisterComponent,
                    AuthIconComponent,
                    ClickElsewhereDirective
                ],
                exports: [
                    AuthIconComponent
                ],
                providers: [
                    AuthenticationService,
                    AuthGuard,
                    {
                        provide: HTTP_INTERCEPTORS,
                        useClass: TokenInterceptor,
                        multi: true
                    },
                ]
            },] }
];

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */

export { AUTHTICATION_SERVER_ROOT_URI, AUTHTICATION_LOGIN_PAGE_URI, AUTHTICATION_INTERFACES, AuthGuard, AuthenticationService, AuthenticationModule, AuthIconComponent as ɵe, ClickElsewhereDirective as ɵf, AuthRoutingModule as ɵa, AuthenticationComponent as ɵb, TokenInterceptor as ɵg, LoginComponent as ɵc, RegisterComponent as ɵd };

//# sourceMappingURL=mdds-angular-auth.js.map