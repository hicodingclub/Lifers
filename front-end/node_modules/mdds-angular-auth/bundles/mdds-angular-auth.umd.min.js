!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/common"),require("@angular/forms"),require("@angular/common/http"),require("rxjs"),require("rxjs/operators"),require("@angular/router"),require("@angular/core")):"function"==typeof define&&define.amd?define("mdds-angular-auth",["exports","@angular/common","@angular/forms","@angular/common/http","rxjs","rxjs/operators","@angular/router","@angular/core"],t):t(e["mdds-angular-auth"]={},e.ng.common,e.ng.forms,e.ng.common.http,e.rxjs,e.rxjs.operators,e.ng.router,e.ng.core)}(this,function(e,t,r,o,i,s,a,n){"use strict";var u=new n.InjectionToken("AUTHTICATION_SERVER_ROOT_URI"),c=new n.InjectionToken("AUTHTICATION_LOGIN_PAGE_URI"),d=new n.InjectionToken("AUTHTICATION_INTERFACES"),l=function(){function e(e,t,r){var n=this;this.authServerRootUri=e,this.router=t,this.http=r,this.adminInterface=!1,this.navigateEndTime=Date.now(),t.events.subscribe(function(e){e instanceof a.NavigationEnd&&(n.previousUrl=n.currentUrl,n.navigateEndTime=Date.now(),e.urlAfterRedirects?n.currentUrl=e.urlAfterRedirects:n.currentUrl=e.url)}),this.adminInterface=JSON.parse(localStorage.getItem("adminInterface"))}return e.prototype.isAuthorized=function(){var e=JSON.parse(localStorage.getItem("mdds-auth-record"));return!(!e||!e.accessToken)},e.prototype.getLogoutTime=function(){var e=JSON.parse(localStorage.getItem("mdds-auth-record"));return e&&"logoutTs"in e?e.logoutTs:0},e.prototype.getAccessToken=function(){var e=JSON.parse(localStorage.getItem("mdds-auth-record"));return e?e.accessToken:null},e.prototype.refreshToken=function(){var t=this,e=JSON.parse(localStorage.getItem("mdds-auth-record"));e||(e={refreshToken:"",userName:""});var r=e.refreshToken,n=e.userName;return this.http.post(this.authServerRootUri+"/refresh",{refreshToken:r,userName:n}).pipe(s.map(this.loggedIn),s.catchError(function(e){return t.logout(),e}))},e.prototype.refreshShouldHappen=function(e){return 401===e.status},e.prototype.verifyTokenRequest=function(e){return!(!e.endsWith(this.authServerRootUri+"/refresh")&&!e.endsWith(this.authServerRootUri+"/login"))},e.prototype.getInterruptedUrl=function(){return this.interruptedUrl||"/"},e.prototype.getRoutedFromUrl=function(){return this.routedFromUrl||"/"},e.prototype.setInterruptedUrl=function(e){this.interruptedUrl=e,1e3<Date.now()-this.navigateEndTime?this.routedFromUrl=this.currentUrl:this.routedFromUrl=this.previousUrl},e.prototype.getUserName=function(){var e=JSON.parse(localStorage.getItem("mdds-auth-record"));return e||(e={userName:""}),e.userName},e.prototype.login=function(e,t){var r={userName:e,accessToken:"",refreshToken:"",displayName:""};localStorage.setItem("mdds-auth-record",JSON.stringify(r));var n=this.adminInterface?{params:(new o.HttpParams).set("type","admin")}:{};return this.http.post(this.authServerRootUri+"/login",{username:e,password:t},n).pipe(s.map(this.loggedIn))},e.prototype.register=function(e){localStorage.removeItem("mdds-auth-record");var t={userName:e.userName,accessToken:"",refreshToken:"",displayName:e.displayName};localStorage.setItem("mdds-auth-record",JSON.stringify(t));var r=this.adminInterface?{params:(new o.HttpParams).set("type","admin")}:{};return this.http.post(this.authServerRootUri+"/register",e,r)},e.prototype.loggedIn=function(e){var t={userName:"",accessToken:"",refreshToken:"",displayName:""};return e&&e.accessToken&&(t.accessToken=e.accessToken),e&&e.refreshToken&&(t.refreshToken=e.refreshToken),e&&e.displayName&&(t.displayName=e.displayName),e&&e.userName&&(t.userName=e.userName),localStorage.setItem("mdds-auth-record",JSON.stringify(t)),e},e.prototype.logout=function(){var e=JSON.parse(localStorage.getItem("mdds-auth-record"));e||(e={}),e.logoutTs=Date.now(),e.accessToken="",e.refreshToken="",localStorage.setItem("mdds-auth-record",JSON.stringify(e))},e.prototype.setAdminInterface=function(e){this.adminInterface=e,localStorage.setItem("adminInterface",JSON.stringify(e))},e.prototype.isAdminInterface=function(){return this.adminInterface},e.decorators=[{type:n.Injectable}],e.ctorParameters=function(){return[{type:String,decorators:[{type:n.Inject,args:[u]}]},{type:a.Router},{type:o.HttpClient}]},e}(),A=function(){function e(e,t,r){this.router=e,this.authService=t,this.loginPageUri=r}return e.prototype.canActivate=function(e,t){return!!this.authService.isAuthorized()||(this.authService.setInterruptedUrl(t.url),this.router.navigate([this.loginPageUri]),!1)},e.prototype.canActivateChild=function(e,t){return this.canActivate(e,t)},e.decorators=[{type:n.Injectable}],e.ctorParameters=function(){return[{type:a.Router},{type:l},{type:String,decorators:[{type:n.Inject,args:[c]}]}]},e}(),p=function(){function e(e,t){this.authenticationService=e,this.authenticationInterfaces=t,this.adminInterface=!1,this.userIntEnabled=!1,this.adminIntEnabled=!1;var r=t.toLowerCase();r.includes("user")&&r.includes("admin")?(this.adminInterface=e.isAdminInterface(),this.userIntEnabled=!0,this.adminIntEnabled=!0):r.includes("admin")?(this.authenticationService.setAdminInterface(!0),this.adminIntEnabled=!0):(this.authenticationService.setAdminInterface(!1),this.userIntEnabled=!0)}return e.prototype.setAdminInterface=function(e){this.adminInterface=e,this.authenticationService.setAdminInterface(this.adminInterface)},e.decorators=[{type:n.Component,args:[{selector:"app-auth",template:'<div class="container">\n    <div class="row mt-5">\n        <div class="col-md-6 offset-md-3">\n            <router-outlet></router-outlet>\n        </div>\n    </div>\n</div>\n'}]}],e.ctorParameters=function(){return[{type:l},{type:String,decorators:[{type:n.Inject,args:[d]}]}]},e}(),h=function(){function e(e,t,r,n){this.formBuilder=e,this.route=t,this.router=r,this.authenticationService=n,this.loading=!1,this.submitted=!1,this.servererror=!1,this.serverText=""}return e.prototype.ngOnInit=function(){this.loginForm=this.formBuilder.group({username:["",r.Validators.required],password:["",r.Validators.required]}),this.authenticationService.logout()},Object.defineProperty(e.prototype,"f",{get:function(){return this.loginForm.controls},enumerable:!0,configurable:!0}),e.prototype.onSubmit=function(){var t=this;if(this.submitted=!0,!this.loginForm.invalid){var r=this.authenticationService.getInterruptedUrl();this.router.url===r&&(r="/"),this.loading=!0,this.authenticationService.login(this.f.username.value,this.f.password.value).pipe(s.first()).subscribe(function(e){t.servererror=!1,t.router.navigate([r]),t.loading=!1},function(e){t.servererror=!0,t.serverText=e.error.error,t.loading=!1})}},e.prototype.cancel=function(){var e=this.authenticationService.getRoutedFromUrl();this.router.navigate([e])},e.decorators=[{type:n.Component,args:[{template:'<h2>Login</h2>\n<form [formGroup]="loginForm" (ngSubmit)="onSubmit()">\n    <div class="form-group">\n        <label for="username">Username</label>\n        <input type="text" formControlName="username" class="form-control" [ngClass]="{ \'is-invalid\': submitted && f.username.errors }" />\n        <div *ngIf="submitted && f.username.errors" class="invalid-feedback">\n            <div *ngIf="f.username.errors.required">Username is required</div>\n        </div>\n    </div>\n    <div class="form-group">\n        <label for="password">Password</label>\n        <input type="password" formControlName="password" class="form-control" [ngClass]="{ \'is-invalid\': submitted && f.password.errors }" />\n        <div *ngIf="submitted && f.password.errors" class="invalid-feedback">\n            <div *ngIf="f.password.errors.required">Password is required</div>\n        </div>\n    </div>\n    <div class="form-group">\n        <button [disabled]="loading" class="btn btn-primary" (click)="onSubmit();">Login</button>\n        <img *ngIf="loading" src="data:image/gif;base64,R0lGODlhEAAQAPIAAP///wAAAMLCwkJCQgAAAGJiYoKCgpKSkiH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAADMwi63P4wyklrE2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQJCgAAACwAAAAAEAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUkKhIAIfkECQoAAAAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkECQoAAAAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYumCYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkECQoAAAAsAAAAABAAEAAAAzIIunInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQJCgAAACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJibufbSlKAAAh+QQJCgAAACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFGxTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAkKAAAALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdceCAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA==" />\n        <a [routerLink]="[\'../register\']" class="btn btn-link">Register</a>\n        <button type="button" (click)="cancel()" class="btn btn-link float-right">Cancel</button>\n    </div>\n    <div *ngIf="servererror" style="display: block;" class="invalid-feedback">\n  \t\t{{serverText}}\n    </div>\n</form>',styles:[""]}]}],e.ctorParameters=function(){return[{type:r.FormBuilder},{type:a.ActivatedRoute},{type:a.Router},{type:l}]},e}(),g=function(e){return e.controls.password_conf.value===e.controls.password.value||e.controls.password_conf.setErrors({passwordNotSame:!0}),null},m=function(){function e(e,t,r,n){this.formBuilder=e,this.router=t,this.route=r,this.authenticationService=n,this.loading=!1,this.submitted=!1,this.servererror=!1,this.serverText=""}return e.prototype.ngOnInit=function(){this.registerForm=this.formBuilder.group({username:["",r.Validators.required],password:["",[r.Validators.required,r.Validators.minLength(6)]],password_conf:["",[r.Validators.required,r.Validators.minLength(6)]]},{validator:g})},Object.defineProperty(e.prototype,"f",{get:function(){return this.registerForm.controls},enumerable:!0,configurable:!0}),e.prototype.onSubmit=function(){var t=this;this.submitted=!0,this.registerForm.invalid||(this.loading=!0,this.authenticationService.register(this.registerForm.value).pipe(s.first()).subscribe(function(e){t.router.navigate(["../login"],{relativeTo:t.route}),t.servererror=!1},function(e){t.servererror=!0,t.serverText=e.error.error,t.loading=!1}))},e.prototype.cancel=function(){var e=this.authenticationService.getRoutedFromUrl();this.router.navigate([e])},e.decorators=[{type:n.Component,args:[{template:'<h2>Register</h2>\n<form [formGroup]="registerForm" (ngSubmit)="onSubmit()">\n    <div class="form-group">\n        <label for="username">Username</label>\n        <input type="text" formControlName="username" class="form-control" [ngClass]="{ \'is-invalid\': submitted && f.username.errors }" />\n        <div *ngIf="submitted && f.username.errors" class="invalid-feedback">\n            <div *ngIf="f.username.errors.required">Username is required</div>\n        </div>\n    </div>\n    <div class="form-group">\n        <label for="password">Password</label>\n        <input type="password" formControlName="password" class="form-control" [ngClass]="{ \'is-invalid\': submitted && f.password.errors }" />\n        <div *ngIf="submitted && f.password.errors" class="invalid-feedback">\n            <div *ngIf="f.password.errors.required">Password is required</div>\n            <div *ngIf="f.password.errors.minlength">Password must be at least 6 characters</div>\n        </div>\n    </div>\n    <div class="form-group">\n        <label for="password_conf">Confirm Password</label>\n        <input type="password" formControlName="password_conf" class="form-control" [ngClass]="{ \'is-invalid\': submitted && f.password_conf.errors }" />\n        <div *ngIf="submitted && f.password_conf.errors" class="invalid-feedback">\n            <div *ngIf="f.password_conf.errors.required">Password is required</div>\n            <div *ngIf="f.password_conf.errors.minlength">Password must be at least 6 characters</div>\n            <div *ngIf="f.password_conf.errors.passwordNotSame">Password doesn\'t match.</div>\n        </div>\n    </div>\n    <div class="form-group">\n        <button [disabled]="loading" class="btn btn-primary">Register</button>\n        <img *ngIf="loading" src="data:image/gif;base64,R0lGODlhEAAQAPIAAP///wAAAMLCwkJCQgAAAGJiYoKCgpKSkiH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAADMwi63P4wyklrE2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQJCgAAACwAAAAAEAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUkKhIAIfkECQoAAAAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkECQoAAAAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYumCYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkECQoAAAAsAAAAABAAEAAAAzIIunInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQJCgAAACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJibufbSlKAAAh+QQJCgAAACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFGxTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAkKAAAALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdceCAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA==" />\n\n        <a [routerLink]="[\'../login\']" class="btn btn-link">Login</a>\n        <button (click)="cancel()" class="btn btn-link float-right">Cancel</button>\n    </div>\n    <div *ngIf="servererror" style="display: block;" class="invalid-feedback">\n  \t\t{{serverText}}\n    </div>\n</form>\n',styles:[".invalid-feedback{width:100%;margin-top:.25rem;font-size:80%;color:#dc3545}"]}]}],e.ctorParameters=function(){return[{type:r.FormBuilder},{type:a.Router},{type:a.ActivatedRoute},{type:l}]},e}(),f=[{path:"auth",component:p,children:[{path:"login",component:h},{path:"register",component:m},{path:"",redirectTo:"login",pathMatch:"full"},{path:"**",redirectTo:"login"}]}],v=function(){function e(){}return e.decorators=[{type:n.NgModule,args:[{imports:[a.RouterModule.forChild(f)],exports:[a.RouterModule]}]}],e}(),I=function(){function e(e,t,r){this.router=e,this.authService=t,this.loginPageUri=r,this.refreshTokenInProgress=!1,this.refreshTokenSubject=new i.BehaviorSubject(null)}return e.prototype.addAuthHeader=function(e){return this.authService.isAuthorized()&&(e=e.clone({setHeaders:{Authorization:"Bearer "+this.authService.getAccessToken()}})),e},e.prototype.intercept=function(t,r){var n=this;return r.handle(this.addAuthHeader(t)).pipe(s.catchError(function(e){return e instanceof o.HttpErrorResponse&&401===e.status?n.refreshTokenInProgress&&!n.authService.verifyTokenRequest(t.url)?n.refreshTokenSubject.pipe(s.filter(function(e){return null!==e}),s.take(1),s.switchMap(function(){return r.handle(n.addAuthHeader(t))})):(n.refreshTokenInProgress=!0,n.refreshTokenSubject.next(null),n.authService.refreshToken().pipe(s.switchMap(function(e){return n.refreshTokenInProgress=!1,n.refreshTokenSubject.next(e),r.handle(n.addAuthHeader(t))}),s.catchError(function(e){return n.refreshTokenInProgress=!1,n.authService.setInterruptedUrl(n.router.url),n.router.navigate([n.loginPageUri]),i.EMPTY}))):(n.authService.verifyTokenRequest(t.url)&&(n.refreshTokenInProgress=!1,n.authService.setInterruptedUrl(n.router.url),n.router.navigate([n.loginPageUri])),i.throwError(e))}))},e.decorators=[{type:n.Injectable}],e.ctorParameters=function(){return[{type:a.Router},{type:l},{type:String,decorators:[{type:n.Inject,args:[c]}]}]},e}(),y=function(){function e(e,t,r){this.router=e,this.authService=t,this.loginPageUri=r,this.popup=!1,this.popupStyle={},this.userName="Please login",this.userNameShort="Please login"}return e.prototype.ngOnInit=function(){this.isAuthorized()},e.prototype.toggle=function(e){if(!this.popup){var t=window.innerWidth-e.x-2,r=e.y+15;this.popupStyle={right:t.toString()+"px",top:r.toString()+"px"}}this.popup=!this.popup},e.prototype.closePopup=function(){this.popup=!1},e.prototype.isAuthorized=function(){var e=this.authService.getUserName(),t=this.authService.isAuthorized();return e&&(this.userName=e,t?12<e.length?this.userNameShort=e.substring(0,10)+"...":this.userNameShort=e.substring(0,13):this.userNameShort="Please login"),t},e.prototype.login=function(){var e=this.router.routerState.snapshot;this.authService.setInterruptedUrl(e.url),this.popup=!1,this.router.navigate([this.loginPageUri])},e.prototype.logout=function(){this.authService.logout(),this.popup=!1,this.router.navigated=!1,this.router.navigate(["/"])},e.decorators=[{type:n.Component,args:[{selector:"app-auth-icon",template:'<div class=\'auth-icon-container\' (clickElsewhere)="closePopup()">\n\n\t<div class="auth-icon" [ngClass]="{\'auth-icon-active\': isAuthorized()}" (click)="toggle($event)">\n\t\t<span class="icon-text"><i class="fas fa-user"></i></span>\n\t</div>\n\n    <div>{{userNameShort}}</div>\n\n\t<div *ngIf="popup" class="auth-icon-pop" [ngStyle]="popupStyle">\n\t  <div class="dropdown-menu pop-menu-container">\n\t  \t<label class="login-name">{{userName}}</label>\n\t  \n\t  \t<div class="dropdown-divider"></div>\n\t    <ng-container *ngIf="isAuthorized(); else notAuthorized">\n\t\t    <a class="dropdown-item" href="#">Profile</a>\n\t\t    \n\t\t    <div class="dropdown-divider"></div>\n\t\t    \n\t\t    <a class="dropdown-item btn" (click)="logout()">Logout</a>\n\t\t</ng-container>\n\t    <ng-template #notAuthorized>\t\t    \n\t\t    <a class="dropdown-item btn" (click)="login()">Login</a>\n\t\t</ng-template>\n\t  </div>\n    </div>\n</div>',styles:[".auth-icon{margin-left:auto;margin-right:auto;background-color:#aaa;height:2.5rem;width:2.5rem;border-radius:50%;text-align:center;cursor:pointer}.auth-icon-active{background-color:#5aa046}.icon-text{font-size:1.5rem;margin-top:.5rem}.auth-icon:hover{background-color:#c8c8c8}.auth-icon-active:hover{background-color:#78aa6e}.auth-icon-pop{position:absolute;z-index:10}.pop-menu-container{position:relative;display:block}.login-name{width:100%;font-style:italic;text-align:center}"]}]}],e.ctorParameters=function(){return[{type:a.Router},{type:l},{type:String,decorators:[{type:n.Inject,args:[c]}]}]},e}(),w=function(){function e(e){this.elementRef=e,this.clickElsewhere=new n.EventEmitter}return e.prototype.onDocumentClick=function(e){var t=e.target;t&&!this.elementRef.nativeElement.contains(t)&&this.clickElsewhere.emit(e)},e.decorators=[{type:n.Directive,args:[{selector:"[clickElsewhere]"}]}],e.ctorParameters=function(){return[{type:n.ElementRef}]},e.propDecorators={clickElsewhere:[{type:n.Output}],onDocumentClick:[{type:n.HostListener,args:["document:click",["$event"]]}]},e}(),b=function(){function e(){}return e.decorators=[{type:n.NgModule,args:[{imports:[t.CommonModule,r.FormsModule,r.ReactiveFormsModule,o.HttpClientModule,v],declarations:[p,h,m,y,w],exports:[y],providers:[l,A,{provide:o.HTTP_INTERCEPTORS,useClass:I,multi:!0}]}]}],e}();e.AUTHTICATION_SERVER_ROOT_URI=u,e.AUTHTICATION_LOGIN_PAGE_URI=c,e.AUTHTICATION_INTERFACES=d,e.AuthGuard=A,e.AuthenticationService=l,e.AuthenticationModule=b,e.ɵe=y,e.ɵf=w,e.ɵa=v,e.ɵb=p,e.ɵg=I,e.ɵc=h,e.ɵd=m,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=mdds-angular-auth.umd.min.js.map