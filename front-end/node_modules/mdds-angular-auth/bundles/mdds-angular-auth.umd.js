(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('@angular/common'), require('@angular/forms'), require('@angular/common/http'), require('rxjs'), require('rxjs/operators'), require('@angular/router'), require('@angular/core')) :
    typeof define === 'function' && define.amd ? define('mdds-angular-auth', ['exports', '@angular/common', '@angular/forms', '@angular/common/http', 'rxjs', 'rxjs/operators', '@angular/router', '@angular/core'], factory) :
    (factory((global['mdds-angular-auth'] = {}),global.ng.common,global.ng.forms,global.ng.common.http,global.rxjs,global.rxjs.operators,global.ng.router,global.ng.core));
}(this, (function (exports,common,forms,http,rxjs,operators,router,core) { 'use strict';

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
     */
    /** @type {?} */
    var AUTHTICATION_SERVER_ROOT_URI = new core.InjectionToken('AUTHTICATION_SERVER_ROOT_URI');
    /** @type {?} */
    var AUTHTICATION_LOGIN_PAGE_URI = new core.InjectionToken('AUTHTICATION_LOGIN_PAGE_URI');
    /** @type {?} */
    var AUTHTICATION_INTERFACES = new core.InjectionToken('AUTHTICATION_INTERFACES');

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
     */
    var AuthenticationService = /** @class */ (function () {
        function AuthenticationService(authServerRootUri, router$$1, http$$1) {
            var _this = this;
            this.authServerRootUri = authServerRootUri;
            this.router = router$$1;
            this.http = http$$1;
            this.adminInterface = false;
            this.navigateEndTime = Date.now();
            router$$1.events.subscribe(function (event) {
                if (event instanceof router.NavigationEnd) {
                    _this.previousUrl = _this.currentUrl;
                    _this.navigateEndTime = Date.now();
                    if (event.urlAfterRedirects) {
                        _this.currentUrl = event.urlAfterRedirects;
                    }
                    else {
                        _this.currentUrl = event.url;
                    }
                }
            });
            this.adminInterface = JSON.parse(localStorage.getItem('adminInterface'));
        }
        /**
         * @return {?}
         */
        AuthenticationService.prototype.isAuthorized = /**
         * @return {?}
         */
            function () {
                /** @type {?} */
                var authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
                if (authRecord && authRecord['accessToken']) {
                    return true;
                }
                return false;
            };
        /**
         * @private
         * @return {?}
         */
        AuthenticationService.prototype.getLogoutTime = /**
         * @private
         * @return {?}
         */
            function () {
                /** @type {?} */
                var authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
                if (authRecord && 'logoutTs' in authRecord) {
                    return authRecord.logoutTs;
                }
                return 0;
            };
        /**
         * @return {?}
         */
        AuthenticationService.prototype.getAccessToken = /**
         * @return {?}
         */
            function () {
                /** @type {?} */
                var authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
                if (authRecord) {
                    return authRecord['accessToken'];
                }
                return null;
            };
        /**
         * @return {?}
         */
        AuthenticationService.prototype.refreshToken = /**
         * @return {?}
         */
            function () {
                var _this = this;
                /** @type {?} */
                var authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
                if (!authRecord) {
                    authRecord = { refreshToken: '', userName: '' };
                }
                /** @type {?} */
                var refreshToken = authRecord['refreshToken'];
                /** @type {?} */
                var userName = authRecord['userName'];
                return this.http.post(this.authServerRootUri + '/refresh', { refreshToken: refreshToken, userName: userName }).pipe(operators.map(this.loggedIn), operators.catchError(function (error) {
                    _this.logout();
                    return error;
                }));
            };
        /**
         * @param {?} response
         * @return {?}
         */
        AuthenticationService.prototype.refreshShouldHappen = /**
         * @param {?} response
         * @return {?}
         */
            function (response) {
                return response.status === 401;
            };
        /**
         * @param {?} url
         * @return {?}
         */
        AuthenticationService.prototype.verifyTokenRequest = /**
         * @param {?} url
         * @return {?}
         */
            function (url) {
                if (url.endsWith(this.authServerRootUri + '/refresh') ||
                    url.endsWith(this.authServerRootUri + '/login')) {
                    return true;
                }
                return false;
            };
        /**
         * @return {?}
         */
        AuthenticationService.prototype.getInterruptedUrl = /**
         * @return {?}
         */
            function () {
                return this.interruptedUrl || '/';
            };
        /**
         * @return {?}
         */
        AuthenticationService.prototype.getRoutedFromUrl = /**
         * @return {?}
         */
            function () {
                return this.routedFromUrl || '/';
            };
        /**
         * @param {?} url
         * @return {?}
         */
        AuthenticationService.prototype.setInterruptedUrl = /**
         * @param {?} url
         * @return {?}
         */
            function (url) {
                this.interruptedUrl = url;
                /** @type {?} */
                var currentTime = Date.now();
                if (currentTime - this.navigateEndTime > 1000) {
                    // Happend > 1 sec. assume it is triggered from current page.
                    this.routedFromUrl = this.currentUrl;
                }
                else {
                    // page transitioned
                    this.routedFromUrl = this.previousUrl;
                }
            };
        /**
         * @return {?}
         */
        AuthenticationService.prototype.getUserName = /**
         * @return {?}
         */
            function () {
                /** @type {?} */
                var authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
                if (!authRecord) {
                    authRecord = { userName: '' };
                }
                return authRecord['userName'];
            };
        /**
         * @param {?} userName
         * @param {?} password
         * @return {?}
         */
        AuthenticationService.prototype.login = /**
         * @param {?} userName
         * @param {?} password
         * @return {?}
         */
            function (userName, password) {
                /** @type {?} */
                var authRecord = {
                    userName: userName,
                    accessToken: '',
                    refreshToken: '',
                    displayName: ''
                };
                localStorage.setItem('mdds-auth-record', JSON.stringify(authRecord));
                /** @type {?} */
                var options = this.adminInterface ?
                    { params: new http.HttpParams().set('type', 'admin') } : {};
                return this.http.post(this.authServerRootUri + '/login', { username: userName, password: password }, options).pipe(operators.map(this.loggedIn));
            };
        /**
         * @param {?} userInfo
         * @return {?}
         */
        AuthenticationService.prototype.register = /**
         * @param {?} userInfo
         * @return {?}
         */
            function (userInfo) {
                localStorage.removeItem('mdds-auth-record');
                /** @type {?} */
                var authRecord = {
                    userName: userInfo.userName,
                    accessToken: '',
                    refreshToken: '',
                    displayName: userInfo.displayName
                };
                localStorage.setItem('mdds-auth-record', JSON.stringify(authRecord));
                /** @type {?} */
                var options = this.adminInterface ?
                    { params: new http.HttpParams().set('type', 'admin') } : {};
                return this.http.post(this.authServerRootUri + '/register', userInfo, options);
            };
        /**
         * @param {?} user
         * @return {?}
         */
        AuthenticationService.prototype.loggedIn = /**
         * @param {?} user
         * @return {?}
         */
            function (user) {
                /** @type {?} */
                var authRecord = {
                    userName: '',
                    accessToken: '',
                    refreshToken: '',
                    displayName: ''
                };
                if (user && user.accessToken) {
                    authRecord['accessToken'] = user.accessToken;
                }
                if (user && user.refreshToken) {
                    authRecord['refreshToken'] = user.refreshToken;
                }
                if (user && user.displayName) {
                    authRecord['displayName'] = user.displayName;
                }
                if (user && user.userName) {
                    authRecord['userName'] = user.userName;
                }
                localStorage.setItem('mdds-auth-record', JSON.stringify(authRecord));
                return user;
            };
        /**
         * @return {?}
         */
        AuthenticationService.prototype.logout = /**
         * @return {?}
         */
            function () {
                // remove user from local storage to log user out
                /** @type {?} */
                var authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
                if (!authRecord) {
                    authRecord = {};
                }
                authRecord.logoutTs = Date.now();
                authRecord.accessToken = '';
                authRecord.refreshToken = '';
                localStorage.setItem('mdds-auth-record', JSON.stringify(authRecord));
            };
        /**
         * @param {?} isAdminInterface
         * @return {?}
         */
        AuthenticationService.prototype.setAdminInterface = /**
         * @param {?} isAdminInterface
         * @return {?}
         */
            function (isAdminInterface) {
                this.adminInterface = isAdminInterface;
                localStorage.setItem('adminInterface', JSON.stringify(isAdminInterface));
            };
        /**
         * @return {?}
         */
        AuthenticationService.prototype.isAdminInterface = /**
         * @return {?}
         */
            function () {
                return this.adminInterface;
            };
        AuthenticationService.decorators = [
            { type: core.Injectable }
        ];
        /** @nocollapse */
        AuthenticationService.ctorParameters = function () {
            return [
                { type: String, decorators: [{ type: core.Inject, args: [AUTHTICATION_SERVER_ROOT_URI,] }] },
                { type: router.Router },
                { type: http.HttpClient }
            ];
        };
        return AuthenticationService;
    }());

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
     */
    var AuthGuard = /** @class */ (function () {
        function AuthGuard(router$$1, authService, loginPageUri) {
            this.router = router$$1;
            this.authService = authService;
            this.loginPageUri = loginPageUri;
        }
        /**
         * @param {?} route
         * @param {?} state
         * @return {?}
         */
        AuthGuard.prototype.canActivate = /**
         * @param {?} route
         * @param {?} state
         * @return {?}
         */
            function (route, state) {
                if (this.authService.isAuthorized()) {
                    // logged in so return true
                    return true;
                }
                // not logged in so redirect to login page with the return url
                this.authService.setInterruptedUrl(state.url);
                this.router.navigate([this.loginPageUri]);
                return false;
            };
        /**
         * @param {?} route
         * @param {?} state
         * @return {?}
         */
        AuthGuard.prototype.canActivateChild = /**
         * @param {?} route
         * @param {?} state
         * @return {?}
         */
            function (route, state) {
                return this.canActivate(route, state);
            };
        AuthGuard.decorators = [
            { type: core.Injectable }
        ];
        /** @nocollapse */
        AuthGuard.ctorParameters = function () {
            return [
                { type: router.Router },
                { type: AuthenticationService },
                { type: String, decorators: [{ type: core.Inject, args: [AUTHTICATION_LOGIN_PAGE_URI,] }] }
            ];
        };
        return AuthGuard;
    }());

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
     */
    var AuthenticationComponent = /** @class */ (function () {
        function AuthenticationComponent(authenticationService, authenticationInterfaces) {
            this.authenticationService = authenticationService;
            this.authenticationInterfaces = authenticationInterfaces;
            this.adminInterface = false;
            this.userIntEnabled = false;
            this.adminIntEnabled = false;
            /** @type {?} */
            var str = authenticationInterfaces.toLowerCase();
            if (str.includes("user") && str.includes("admin")) { //both interface. Check cached.
                this.adminInterface = authenticationService.isAdminInterface();
                this.userIntEnabled = true;
                this.adminIntEnabled = true;
            }
            else if (str.includes("admin")) { //administrator only
                this.authenticationService.setAdminInterface(true);
                this.adminIntEnabled = true;
            }
            else { //users only
                this.authenticationService.setAdminInterface(false);
                this.userIntEnabled = true;
            }
        }
        /**
         * @param {?} adminInterface
         * @return {?}
         */
        AuthenticationComponent.prototype.setAdminInterface = /**
         * @param {?} adminInterface
         * @return {?}
         */
            function (adminInterface) {
                this.adminInterface = adminInterface;
                this.authenticationService.setAdminInterface(this.adminInterface);
            };
        AuthenticationComponent.decorators = [
            { type: core.Component, args: [{
                        selector: 'app-auth',
                        template: "<div class=\"container\">\n    <div class=\"row mt-5\">\n        <div class=\"col-md-6 offset-md-3\">\n            <router-outlet></router-outlet>\n        </div>\n    </div>\n</div>\n"
                    }] }
        ];
        /** @nocollapse */
        AuthenticationComponent.ctorParameters = function () {
            return [
                { type: AuthenticationService },
                { type: String, decorators: [{ type: core.Inject, args: [AUTHTICATION_INTERFACES,] }] }
            ];
        };
        return AuthenticationComponent;
    }());

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
     */
    var LoginComponent = /** @class */ (function () {
        function LoginComponent(formBuilder, route, router$$1, authenticationService) {
            this.formBuilder = formBuilder;
            this.route = route;
            this.router = router$$1;
            this.authenticationService = authenticationService;
            this.loading = false;
            this.submitted = false;
            this.servererror = false;
            this.serverText = '';
        }
        /**
         * @return {?}
         */
        LoginComponent.prototype.ngOnInit = /**
         * @return {?}
         */
            function () {
                this.loginForm = this.formBuilder.group({
                    username: ['', forms.Validators.required],
                    password: ['', forms.Validators.required]
                });
                // reset login status
                this.authenticationService.logout();
                // get return url from route parameters or default to '/'
                // this.returnUrl = this.route.snapshot.queryParams['returnUrl'] || '/';
            };
        Object.defineProperty(LoginComponent.prototype, "f", {
            // convenience getter for easy access to form fields
            get: 
            // convenience getter for easy access to form fields
            /**
             * @return {?}
             */
            function () { return this.loginForm.controls; },
            enumerable: true,
            configurable: true
        });
        /**
         * @return {?}
         */
        LoginComponent.prototype.onSubmit = /**
         * @return {?}
         */
            function () {
                var _this = this;
                this.submitted = true;
                // stop here if form is invalid
                if (this.loginForm.invalid) {
                    return;
                }
                /** @type {?} */
                var returnUrl = this.authenticationService.getInterruptedUrl();
                if (this.router.url === returnUrl) {
                    returnUrl = '/';
                } // home page
                this.loading = true;
                this.authenticationService.login(this.f.username.value, this.f.password.value)
                    .pipe(operators.first())
                    .subscribe(function (data) {
                    _this.servererror = false;
                    _this.router.navigate([returnUrl]);
                    _this.loading = false;
                }, function (error) {
                    // this.alertService.error(error);
                    _this.servererror = true;
                    _this.serverText = error.error.error;
                    _this.loading = false;
                });
            };
        /**
         * @return {?}
         */
        LoginComponent.prototype.cancel = /**
         * @return {?}
         */
            function () {
                /** @type {?} */
                var routedFromUrl = this.authenticationService.getRoutedFromUrl();
                this.router.navigate([routedFromUrl]);
            };
        LoginComponent.decorators = [
            { type: core.Component, args: [{ template: "<h2>Login</h2>\n<form [formGroup]=\"loginForm\" (ngSubmit)=\"onSubmit()\">\n    <div class=\"form-group\">\n        <label for=\"username\">Username</label>\n        <input type=\"text\" formControlName=\"username\" class=\"form-control\" [ngClass]=\"{ 'is-invalid': submitted && f.username.errors }\" />\n        <div *ngIf=\"submitted && f.username.errors\" class=\"invalid-feedback\">\n            <div *ngIf=\"f.username.errors.required\">Username is required</div>\n        </div>\n    </div>\n    <div class=\"form-group\">\n        <label for=\"password\">Password</label>\n        <input type=\"password\" formControlName=\"password\" class=\"form-control\" [ngClass]=\"{ 'is-invalid': submitted && f.password.errors }\" />\n        <div *ngIf=\"submitted && f.password.errors\" class=\"invalid-feedback\">\n            <div *ngIf=\"f.password.errors.required\">Password is required</div>\n        </div>\n    </div>\n    <div class=\"form-group\">\n        <button [disabled]=\"loading\" class=\"btn btn-primary\" (click)=\"onSubmit();\">Login</button>\n        <img *ngIf=\"loading\" src=\"data:image/gif;base64,R0lGODlhEAAQAPIAAP///wAAAMLCwkJCQgAAAGJiYoKCgpKSkiH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAADMwi63P4wyklrE2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQJCgAAACwAAAAAEAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUkKhIAIfkECQoAAAAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkECQoAAAAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYumCYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkECQoAAAAsAAAAABAAEAAAAzIIunInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQJCgAAACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJibufbSlKAAAh+QQJCgAAACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFGxTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAkKAAAALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdceCAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA==\" />\n        <a [routerLink]=\"['../register']\" class=\"btn btn-link\">Register</a>\n        <button type=\"button\" (click)=\"cancel()\" class=\"btn btn-link float-right\">Cancel</button>\n    </div>\n    <div *ngIf=\"servererror\" style=\"display: block;\" class=\"invalid-feedback\">\n  \t\t{{serverText}}\n    </div>\n</form>", styles: [""] }] }
        ];
        /** @nocollapse */
        LoginComponent.ctorParameters = function () {
            return [
                { type: forms.FormBuilder },
                { type: router.ActivatedRoute },
                { type: router.Router },
                { type: AuthenticationService }
            ];
        };
        return LoginComponent;
    }());

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
     */

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
     */
    /** @type {?} */
    var validatePasswords = function (form) {
        /** @type {?} */
        var passwordConf = form.controls.password_conf.value;
        /** @type {?} */
        var password = form.controls.password.value;
        if (passwordConf === password) {
            return null;
        }
        else {
            form.controls.password_conf.setErrors({ 'passwordNotSame': true });
            return null;
        }
    };
    var RegisterComponent = /** @class */ (function () {
        function RegisterComponent(formBuilder, router$$1, route, authenticationService) {
            this.formBuilder = formBuilder;
            this.router = router$$1;
            this.route = route;
            this.authenticationService = authenticationService;
            this.loading = false;
            this.submitted = false;
            this.servererror = false;
            this.serverText = '';
        }
        /**
         * @return {?}
         */
        RegisterComponent.prototype.ngOnInit = /**
         * @return {?}
         */
            function () {
                this.registerForm = this.formBuilder.group({
                    username: ['', forms.Validators.required],
                    password: ['', [forms.Validators.required, forms.Validators.minLength(6)]],
                    password_conf: ['', [forms.Validators.required, forms.Validators.minLength(6)]]
                }, { validator: validatePasswords });
            };
        Object.defineProperty(RegisterComponent.prototype, "f", {
            // convenience getter for easy access to form fields
            get: 
            // convenience getter for easy access to form fields
            /**
             * @return {?}
             */
            function () { return this.registerForm.controls; },
            enumerable: true,
            configurable: true
        });
        /**
         * @return {?}
         */
        RegisterComponent.prototype.onSubmit = /**
         * @return {?}
         */
            function () {
                var _this = this;
                this.submitted = true;
                // stop here if form is invalid
                if (this.registerForm.invalid) {
                    return;
                }
                this.loading = true;
                this.authenticationService.register(this.registerForm.value)
                    .pipe(operators.first())
                    .subscribe(function (data) {
                    // this.alertService.success('Registration successful', true);
                    _this.router.navigate(['../login'], { relativeTo: _this.route, });
                    _this.servererror = false;
                }, function (error) {
                    // this.alertService.error(error);
                    // alert("Error login");
                    _this.servererror = true;
                    _this.serverText = error.error.error;
                    _this.loading = false;
                });
            };
        /**
         * @return {?}
         */
        RegisterComponent.prototype.cancel = /**
         * @return {?}
         */
            function () {
                /** @type {?} */
                var routedFromUrl = this.authenticationService.getRoutedFromUrl();
                this.router.navigate([routedFromUrl]);
            };
        RegisterComponent.decorators = [
            { type: core.Component, args: [{ template: "<h2>Register</h2>\n<form [formGroup]=\"registerForm\" (ngSubmit)=\"onSubmit()\">\n    <div class=\"form-group\">\n        <label for=\"username\">Username</label>\n        <input type=\"text\" formControlName=\"username\" class=\"form-control\" [ngClass]=\"{ 'is-invalid': submitted && f.username.errors }\" />\n        <div *ngIf=\"submitted && f.username.errors\" class=\"invalid-feedback\">\n            <div *ngIf=\"f.username.errors.required\">Username is required</div>\n        </div>\n    </div>\n    <div class=\"form-group\">\n        <label for=\"password\">Password</label>\n        <input type=\"password\" formControlName=\"password\" class=\"form-control\" [ngClass]=\"{ 'is-invalid': submitted && f.password.errors }\" />\n        <div *ngIf=\"submitted && f.password.errors\" class=\"invalid-feedback\">\n            <div *ngIf=\"f.password.errors.required\">Password is required</div>\n            <div *ngIf=\"f.password.errors.minlength\">Password must be at least 6 characters</div>\n        </div>\n    </div>\n    <div class=\"form-group\">\n        <label for=\"password_conf\">Confirm Password</label>\n        <input type=\"password\" formControlName=\"password_conf\" class=\"form-control\" [ngClass]=\"{ 'is-invalid': submitted && f.password_conf.errors }\" />\n        <div *ngIf=\"submitted && f.password_conf.errors\" class=\"invalid-feedback\">\n            <div *ngIf=\"f.password_conf.errors.required\">Password is required</div>\n            <div *ngIf=\"f.password_conf.errors.minlength\">Password must be at least 6 characters</div>\n            <div *ngIf=\"f.password_conf.errors.passwordNotSame\">Password doesn't match.</div>\n        </div>\n    </div>\n    <div class=\"form-group\">\n        <button [disabled]=\"loading\" class=\"btn btn-primary\">Register</button>\n        <img *ngIf=\"loading\" src=\"data:image/gif;base64,R0lGODlhEAAQAPIAAP///wAAAMLCwkJCQgAAAGJiYoKCgpKSkiH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAADMwi63P4wyklrE2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQJCgAAACwAAAAAEAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUkKhIAIfkECQoAAAAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkECQoAAAAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYumCYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkECQoAAAAsAAAAABAAEAAAAzIIunInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQJCgAAACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJibufbSlKAAAh+QQJCgAAACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFGxTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAkKAAAALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdceCAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA==\" />\n\n        <a [routerLink]=\"['../login']\" class=\"btn btn-link\">Login</a>\n        <button (click)=\"cancel()\" class=\"btn btn-link float-right\">Cancel</button>\n    </div>\n    <div *ngIf=\"servererror\" style=\"display: block;\" class=\"invalid-feedback\">\n  \t\t{{serverText}}\n    </div>\n</form>\n", styles: [".invalid-feedback{width:100%;margin-top:.25rem;font-size:80%;color:#dc3545}"] }] }
        ];
        /** @nocollapse */
        RegisterComponent.ctorParameters = function () {
            return [
                { type: forms.FormBuilder },
                { type: router.Router },
                { type: router.ActivatedRoute },
                { type: AuthenticationService }
            ];
        };
        return RegisterComponent;
    }());

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
     */

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
     */
    /** @type {?} */
    var routes = [
        { path: 'auth',
            component: AuthenticationComponent,
            children: [
                { path: "login", component: LoginComponent },
                { path: 'register', component: RegisterComponent },
                { path: '', redirectTo: 'login', pathMatch: 'full' },
                { path: '**', redirectTo: 'login' }
            ]
        }
    ];
    var AuthRoutingModule = /** @class */ (function () {
        function AuthRoutingModule() {
        }
        AuthRoutingModule.decorators = [
            { type: core.NgModule, args: [{
                        imports: [router.RouterModule.forChild(routes)],
                        exports: [router.RouterModule]
                    },] }
        ];
        return AuthRoutingModule;
    }());

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
     */
    var TokenInterceptor = /** @class */ (function () {
        function TokenInterceptor(router$$1, authService, loginPageUri) {
            this.router = router$$1;
            this.authService = authService;
            this.loginPageUri = loginPageUri;
            this.refreshTokenInProgress = false;
            // Refresh Token Subject tracks the current token, or is null if no token is currently
            // available (e.g. refresh pending).
            this.refreshTokenSubject = new rxjs.BehaviorSubject(null);
        }
        /**
         * @param {?} request
         * @return {?}
         */
        TokenInterceptor.prototype.addAuthHeader = /**
         * @param {?} request
         * @return {?}
         */
            function (request) {
                if (this.authService.isAuthorized()) {
                    request = request.clone({
                        setHeaders: {
                            Authorization: "Bearer " + this.authService.getAccessToken()
                        }
                    });
                }
                return request;
            };
        /**
         * @param {?} request
         * @param {?} next
         * @return {?}
         */
        TokenInterceptor.prototype.intercept = /**
         * @param {?} request
         * @param {?} next
         * @return {?}
         */
            function (request, next) {
                var _this = this;
                return next.handle(this.addAuthHeader(request))
                    .pipe(
                /*
                tap((event: HttpEvent<any>) => {
                    if (event instanceof HttpResponse) {
                      ;
                    }
                  }, (err: any) => {
                    if (err instanceof HttpErrorResponse) {
                      if (err.status === 401) {
                        this.authService.setInterruptedUrl(this.router.url);
                        this.router.navigate([this.loginPageUri]);
                      }
                    }
                })
                */
                operators.catchError(function (error) {
                    if (error instanceof http.HttpErrorResponse && error.status === 401) {
                        if (_this.refreshTokenInProgress && !_this.authService.verifyTokenRequest(request.url)) {
                            // If refreshTokenInProgress is true, we will wait until refreshTokenSubject has a non-null value
                            // – which means the new token is ready and we can retry the request again
                            return _this.refreshTokenSubject.pipe(operators.filter(function (result) { return result !== null; }), operators.take(1), operators.switchMap(function () { return next.handle(_this.addAuthHeader(request)); }));
                        }
                        else {
                            _this.refreshTokenInProgress = true;
                            // Set the refreshTokenSubject to null so that subsequent API calls will wait until the new token has been retrieved
                            _this.refreshTokenSubject.next(null);
                            return _this.authService.refreshToken().pipe(operators.switchMap(function (data) {
                                _this.refreshTokenInProgress = false;
                                _this.refreshTokenSubject.next(data);
                                return next.handle(_this.addAuthHeader(request));
                            }), operators.catchError(function (err) {
                                // looks like this part will not hit
                                _this.refreshTokenInProgress = false;
                                _this.authService.setInterruptedUrl(_this.router.url);
                                _this.router.navigate([_this.loginPageUri]);
                                return rxjs.EMPTY;
                            }));
                        }
                    }
                    if (_this.authService.verifyTokenRequest(request.url)) {
                        // refreshToken failed. Go to login page.
                        _this.refreshTokenInProgress = false;
                        _this.authService.setInterruptedUrl(_this.router.url);
                        _this.router.navigate([_this.loginPageUri]);
                    }
                    return rxjs.throwError(error);
                }));
            };
        TokenInterceptor.decorators = [
            { type: core.Injectable }
        ];
        /** @nocollapse */
        TokenInterceptor.ctorParameters = function () {
            return [
                { type: router.Router },
                { type: AuthenticationService },
                { type: String, decorators: [{ type: core.Inject, args: [AUTHTICATION_LOGIN_PAGE_URI,] }] }
            ];
        };
        return TokenInterceptor;
    }());

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
     */
    var AuthIconComponent = /** @class */ (function () {
        function AuthIconComponent(router$$1, authService, loginPageUri) {
            this.router = router$$1;
            this.authService = authService;
            this.loginPageUri = loginPageUri;
            this.popup = false;
            this.popupStyle = {};
            this.userName = 'Please login';
            this.userNameShort = 'Please login';
        }
        /**
         * @return {?}
         */
        AuthIconComponent.prototype.ngOnInit = /**
         * @return {?}
         */
            function () {
                this.isAuthorized();
            };
        /**
         * @param {?} event
         * @return {?}
         */
        AuthIconComponent.prototype.toggle = /**
         * @param {?} event
         * @return {?}
         */
            function (event) {
                if (!this.popup) {
                    /** @type {?} */
                    var right = (window.innerWidth - event.x) - 2;
                    /** @type {?} */
                    var top_1 = event.y + 15;
                    this.popupStyle = {
                        'right': right.toString() + 'px',
                        'top': top_1.toString() + 'px',
                    };
                }
                this.popup = !this.popup;
            };
        /**
         * @return {?}
         */
        AuthIconComponent.prototype.closePopup = /**
         * @return {?}
         */
            function () {
                this.popup = false;
            };
        /**
         * @return {?}
         */
        AuthIconComponent.prototype.isAuthorized = /**
         * @return {?}
         */
            function () {
                /** @type {?} */
                var name = this.authService.getUserName();
                /** @type {?} */
                var isAuth = this.authService.isAuthorized();
                if (name) {
                    this.userName = name;
                    if (isAuth) {
                        if (name.length > 12) {
                            this.userNameShort = name.substring(0, 10) + '...';
                        }
                        else {
                            this.userNameShort = name.substring(0, 13);
                        }
                    }
                    else {
                        this.userNameShort = 'Please login';
                    }
                }
                return isAuth;
            };
        /**
         * @return {?}
         */
        AuthIconComponent.prototype.login = /**
         * @return {?}
         */
            function () {
                // not logged in so redirect to login page with the return url
                /** @type {?} */
                var state = this.router.routerState.snapshot;
                this.authService.setInterruptedUrl(state.url);
                this.popup = false;
                this.router.navigate([this.loginPageUri]);
            };
        /**
         * @return {?}
         */
        AuthIconComponent.prototype.logout = /**
         * @return {?}
         */
            function () {
                // not logged in so redirect to login page with the return url
                this.authService.logout();
                this.popup = false;
                this.router.navigated = false; // refresh current page;
                this.router.navigate(['/']); // home page
            };
        AuthIconComponent.decorators = [
            { type: core.Component, args: [{
                        selector: 'app-auth-icon',
                        template: "<div class='auth-icon-container' (clickElsewhere)=\"closePopup()\">\n\n\t<div class=\"auth-icon\" [ngClass]=\"{'auth-icon-active': isAuthorized()}\" (click)=\"toggle($event)\">\n\t\t<span class=\"icon-text\"><i class=\"fas fa-user\"></i></span>\n\t</div>\n\n    <div>{{userNameShort}}</div>\n\n\t<div *ngIf=\"popup\" class=\"auth-icon-pop\" [ngStyle]=\"popupStyle\">\n\t  <div class=\"dropdown-menu pop-menu-container\">\n\t  \t<label class=\"login-name\">{{userName}}</label>\n\t  \n\t  \t<div class=\"dropdown-divider\"></div>\n\t    <ng-container *ngIf=\"isAuthorized(); else notAuthorized\">\n\t\t    <a class=\"dropdown-item\" href=\"#\">Profile</a>\n\t\t    \n\t\t    <div class=\"dropdown-divider\"></div>\n\t\t    \n\t\t    <a class=\"dropdown-item btn\" (click)=\"logout()\">Logout</a>\n\t\t</ng-container>\n\t    <ng-template #notAuthorized>\t\t    \n\t\t    <a class=\"dropdown-item btn\" (click)=\"login()\">Login</a>\n\t\t</ng-template>\n\t  </div>\n    </div>\n</div>",
                        styles: [".auth-icon{margin-left:auto;margin-right:auto;background-color:#aaa;height:2.5rem;width:2.5rem;border-radius:50%;text-align:center;cursor:pointer}.auth-icon-active{background-color:#5aa046}.icon-text{font-size:1.5rem;margin-top:.5rem}.auth-icon:hover{background-color:#c8c8c8}.auth-icon-active:hover{background-color:#78aa6e}.auth-icon-pop{position:absolute;z-index:10}.pop-menu-container{position:relative;display:block}.login-name{width:100%;font-style:italic;text-align:center}"]
                    }] }
        ];
        /** @nocollapse */
        AuthIconComponent.ctorParameters = function () {
            return [
                { type: router.Router },
                { type: AuthenticationService },
                { type: String, decorators: [{ type: core.Inject, args: [AUTHTICATION_LOGIN_PAGE_URI,] }] }
            ];
        };
        return AuthIconComponent;
    }());

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
     */
    var ClickElsewhereDirective = /** @class */ (function () {
        function ClickElsewhereDirective(elementRef) {
            this.elementRef = elementRef;
            this.clickElsewhere = new core.EventEmitter();
        }
        /**
         * @param {?} event
         * @return {?}
         */
        ClickElsewhereDirective.prototype.onDocumentClick = /**
         * @param {?} event
         * @return {?}
         */
            function (event) {
                /** @type {?} */
                var targetElement = ( /** @type {?} */(event.target));
                // Check if the click was outside the element
                if (targetElement && !this.elementRef.nativeElement.contains(targetElement)) {
                    this.clickElsewhere.emit(event);
                }
            };
        ClickElsewhereDirective.decorators = [
            { type: core.Directive, args: [{ selector: '[clickElsewhere]' },] }
        ];
        /** @nocollapse */
        ClickElsewhereDirective.ctorParameters = function () {
            return [
                { type: core.ElementRef }
            ];
        };
        ClickElsewhereDirective.propDecorators = {
            clickElsewhere: [{ type: core.Output }],
            onDocumentClick: [{ type: core.HostListener, args: ['document:click', ['$event'],] }]
        };
        return ClickElsewhereDirective;
    }());

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
     */
    var AuthenticationModule = /** @class */ (function () {
        function AuthenticationModule() {
        }
        AuthenticationModule.decorators = [
            { type: core.NgModule, args: [{
                        imports: [
                            common.CommonModule,
                            forms.FormsModule,
                            forms.ReactiveFormsModule,
                            http.HttpClientModule,
                            AuthRoutingModule
                        ],
                        declarations: [
                            AuthenticationComponent,
                            LoginComponent,
                            RegisterComponent,
                            AuthIconComponent,
                            ClickElsewhereDirective
                        ],
                        exports: [
                            AuthIconComponent
                        ],
                        providers: [
                            AuthenticationService,
                            AuthGuard,
                            {
                                provide: http.HTTP_INTERCEPTORS,
                                useClass: TokenInterceptor,
                                multi: true
                            },
                        ]
                    },] }
        ];
        return AuthenticationModule;
    }());

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
     */

    /**
     * @fileoverview added by tsickle
     * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
     */

    exports.AUTHTICATION_SERVER_ROOT_URI = AUTHTICATION_SERVER_ROOT_URI;
    exports.AUTHTICATION_LOGIN_PAGE_URI = AUTHTICATION_LOGIN_PAGE_URI;
    exports.AUTHTICATION_INTERFACES = AUTHTICATION_INTERFACES;
    exports.AuthGuard = AuthGuard;
    exports.AuthenticationService = AuthenticationService;
    exports.AuthenticationModule = AuthenticationModule;
    exports.ɵe = AuthIconComponent;
    exports.ɵf = ClickElsewhereDirective;
    exports.ɵa = AuthRoutingModule;
    exports.ɵb = AuthenticationComponent;
    exports.ɵg = TokenInterceptor;
    exports.ɵc = LoginComponent;
    exports.ɵd = RegisterComponent;

    Object.defineProperty(exports, '__esModule', { value: true });

})));

//# sourceMappingURL=mdds-angular-auth.umd.js.map