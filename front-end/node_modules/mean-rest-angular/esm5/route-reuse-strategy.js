/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/** @type {?} */
var COMPONENT_CACHE_DURATION = 30 * 1000;
var MraRouteReuseStrategy = /** @class */ (function () {
    function MraRouteReuseStrategy() {
        this.detachedRouteHandles = {}; //key is url, and value is at [handle, timestamp] format
        //key is url, and value is at [handle, timestamp] format
        this.pageYOffset = {};
        this.editItems = {};
        this.isAuth = false;
    }
    /* Start: The following should use the authService. But let's decouple dependency now */
    /* Start: The following should use the authService. But let's decouple dependency now */
    /**
     * @private
     * @return {?}
     */
    MraRouteReuseStrategy.prototype.isAuthorized = /* Start: The following should use the authService. But let's decouple dependency now */
    /**
     * @private
     * @return {?}
     */
    function () {
        //Refer to AuthenticationService for this function.
        /** @type {?} */
        var authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
        if (authRecord && authRecord.accessToken) {
            return true;
        }
        return false;
    };
    /**
     * @private
     * @return {?}
     */
    MraRouteReuseStrategy.prototype.getLogoutTime = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var authRecord = JSON.parse(localStorage.getItem('mdds-auth-record'));
        if (authRecord) {
            return authRecord.logoutTs;
        }
        return 0;
    };
    /* End */
    /* End */
    /**
     * @private
     * @return {?}
     */
    MraRouteReuseStrategy.prototype.isLogoutReload = /* End */
    /**
     * @private
     * @return {?}
     */
    function () {
        if (this.isAuthorized()) {
            return false;
        }
        /** @type {?} */
        var currentTs = Date.now();
        /** @type {?} */
        var logoutTs = this.getLogoutTime();
        if (currentTs - logoutTs < 1000) {
            return true;
        }
        return false;
    };
    /**
     * @private
     * @return {?}
     */
    MraRouteReuseStrategy.prototype.checkAuthentication = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var auth = this.isAuth;
        this.isAuth = this.isAuthorized();
        if (this.isAuth != auth) {
            // authentication status changed. Not attach;
            this.detachedRouteHandles = {}; // empty the map
        }
    };
    /** Determines if this route (and its subtree) should be detached to be reused later */
    /**
     * Determines if this route (and its subtree) should be detached to be reused later
     * @param {?} route
     * @return {?}
     */
    MraRouteReuseStrategy.prototype.shouldDetach = /**
     * Determines if this route (and its subtree) should be detached to be reused later
     * @param {?} route
     * @return {?}
     */
    function (route) {
        if (route.routeConfig && route.routeConfig.path === 'list') {
            //save current scroll position
            /** @type {?} */
            var key = route['_routerState'].url;
            this.pageYOffset[key] = window.pageYOffset;
        }
        return route.routeConfig.path === 'list';
    };
    /** Stores the detached route */
    /**
     * Stores the detached route
     * @param {?} route
     * @param {?} handle
     * @return {?}
     */
    MraRouteReuseStrategy.prototype.store = /**
     * Stores the detached route
     * @param {?} route
     * @param {?} handle
     * @return {?}
     */
    function (route, handle) {
        /** @type {?} */
        var date = new Date();
        /** @type {?} */
        var key = route['_routerState'].url;
        if (!handle)
            return;
        this.detachedRouteHandles[key] = [handle, date.getTime()];
    };
    /** Determines if this route (and its subtree) should be reattached */
    /**
     * Determines if this route (and its subtree) should be reattached
     * @param {?} route
     * @return {?}
     */
    MraRouteReuseStrategy.prototype.shouldAttach = /**
     * Determines if this route (and its subtree) should be reattached
     * @param {?} route
     * @return {?}
     */
    function (route) {
        this.checkAuthentication();
        /** @type {?} */
        var date = new Date();
        /** @type {?} */
        var key = route['_routerState'].url;
        if (route.routeConfig && (route.routeConfig.path === 'new' || route.routeConfig.path === 'edit/:id')) {
            if (route.data && route.data.item) {
                this.editItems[route.data.item] = true;
            }
        }
        if (!route.routeConfig || route.routeConfig.path !== 'list') {
            return false;
        }
        if (!this.detachedRouteHandles[key]) {
            return false;
        }
        if (date.getTime() - this.detachedRouteHandles[key][1] > COMPONENT_CACHE_DURATION)
            return false;
        return true;
    };
    /** Retrieves the previously stored route */
    /**
     * Retrieves the previously stored route
     * @param {?} route
     * @return {?}
     */
    MraRouteReuseStrategy.prototype.retrieve = /**
     * Retrieves the previously stored route
     * @param {?} route
     * @return {?}
     */
    function (route) {
        /** @type {?} */
        var date = new Date();
        /** @type {?} */
        var key = route['_routerState'].url;
        if (!route.routeConfig || route.routeConfig.path !== 'list')
            return null;
        if (route.data.item && (route.data.item in this.editItems)) {
            delete this.editItems[route.data.item];
            delete this.detachedRouteHandles[key];
            return null;
        }
        if (!this.detachedRouteHandles[key])
            return null;
        if (date.getTime() - this.detachedRouteHandles[key][1] > COMPONENT_CACHE_DURATION)
            return null;
        /** @type {?} */
        var yOffset = this.pageYOffset[key];
        setTimeout(function () {
            console.log("==retrieve: ", key, yOffset);
            window.scrollTo(0, yOffset);
        }, 20); //scroll to saved position
        return this.detachedRouteHandles[key][0];
    };
    /** Determines if a route should be reused */
    /**
     * Determines if a route should be reused
     * @param {?} future
     * @param {?} curr
     * @return {?}
     */
    MraRouteReuseStrategy.prototype.shouldReuseRoute = /**
     * Determines if a route should be reused
     * @param {?} future
     * @param {?} curr
     * @return {?}
     */
    function (future, curr) {
        // Below is the default implementation;
        if (this.isLogoutReload()) {
            return false; // authentication status changed. Don't reuse.
        }
        return future.routeConfig === curr.routeConfig;
    };
    return MraRouteReuseStrategy;
}());
export { MraRouteReuseStrategy };
if (false) {
    /** @type {?} */
    MraRouteReuseStrategy.prototype.detachedRouteHandles;
    /** @type {?} */
    MraRouteReuseStrategy.prototype.pageYOffset;
    /** @type {?} */
    MraRouteReuseStrategy.prototype.editItems;
    /** @type {?} */
    MraRouteReuseStrategy.prototype.isAuth;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGUtcmV1c2Utc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9tZWFuLXJlc3QtYW5ndWxhci8iLCJzb3VyY2VzIjpbInJvdXRlLXJldXNlLXN0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0lBRU0sd0JBQXdCLEdBQUcsRUFBRSxHQUFHLElBQUk7QUFDMUM7SUFBQTtRQUVJLHlCQUFvQixHQUE2QixFQUFFLENBQUMsQ0FBQyx3REFBd0Q7O1FBQzdHLGdCQUFXLEdBQUcsRUFBRSxDQUFDO1FBQ2pCLGNBQVMsR0FBRyxFQUFFLENBQUM7UUFDZixXQUFNLEdBQUcsS0FBSyxDQUFDO0lBdUduQixDQUFDO0lBckdHLHdGQUF3Rjs7Ozs7O0lBQ2hGLDRDQUFZOzs7OztJQUFwQjs7O1lBRVUsVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQ3ZFLElBQUksVUFBVSxJQUFJLFVBQVUsQ0FBQyxXQUFXLEVBQUc7WUFBQyxPQUFPLElBQUksQ0FBQztTQUFDO1FBQ3pELE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7Ozs7O0lBQ08sNkNBQWE7Ozs7SUFBckI7O1lBQ1UsVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQ3ZFLElBQUksVUFBVSxFQUFFO1lBQ1osT0FBTyxVQUFVLENBQUMsUUFBUSxDQUFDO1NBQzlCO1FBQ0QsT0FBTyxDQUFDLENBQUM7SUFDYixDQUFDO0lBQ0QsU0FBUzs7Ozs7O0lBRUQsOENBQWM7Ozs7O0lBQXRCO1FBQ0ksSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFLEVBQUU7WUFDckIsT0FBTyxLQUFLLENBQUM7U0FDaEI7O1lBQ0ssU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUU7O1lBQ3RCLFFBQVEsR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFO1FBQ3JDLElB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QUFLLENBQUMsQ0FBQyw4Q0FBOEM7U0FDL0Q7UUFDRCxPQUFPLE1BQU0sQ0FBQyxXQUFXLEtBQUssSUFBSSxDQUFDLFdBQVcsQ0FBQTtJQUNsRCxDQUFDO0lBQ0wsNEJBQUM7QUFBRCxDQUFDLEFBNUdELElBNEdDOzs7O0lBMUdHLHFEQUFvRDs7SUFDcEQsNENBQWlCOztJQUNqQiwwQ0FBZTs7SUFDZix1Q0FBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFjdGl2YXRlZFJvdXRlU25hcHNob3QsIERldGFjaGVkUm91dGVIYW5kbGUsIFJvdXRlUmV1c2VTdHJhdGVneSB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcidcblxuY29uc3QgQ09NUE9ORU5UX0NBQ0hFX0RVUkFUSU9OID0gMzAgKiAxMDAwO1xuZXhwb3J0IGNsYXNzIE1yYVJvdXRlUmV1c2VTdHJhdGVneSBpbXBsZW1lbnRzIFJvdXRlUmV1c2VTdHJhdGVneSB7XG5cbiAgICBkZXRhY2hlZFJvdXRlSGFuZGxlczogeyBba2V5OiBzdHJpbmddOiBhbnlbXSB9ID0ge307IC8va2V5IGlzIHVybCwgYW5kIHZhbHVlIGlzIGF0IFtoYW5kbGUsIHRpbWVzdGFtcF0gZm9ybWF0XG4gICAgcGFnZVlPZmZzZXQgPSB7fTtcbiAgICBlZGl0SXRlbXMgPSB7fTtcbiAgICBpc0F1dGggPSBmYWxzZTtcblxuICAgIC8qIFN0YXJ0OiBUaGUgZm9sbG93aW5nIHNob3VsZCB1c2UgdGhlIGF1dGhTZXJ2aWNlLiBCdXQgbGV0J3MgZGVjb3VwbGUgZGVwZW5kZW5jeSBub3cgKi9cbiAgICBwcml2YXRlIGlzQXV0aG9yaXplZCgpOiBib29sZWFuIHtcbiAgICAgICAgLy9SZWZlciB0byBBdXRoZW50aWNhdGlvblNlcnZpY2UgZm9yIHRoaXMgZnVuY3Rpb24uXG4gICAgICAgIGNvbnN0IGF1dGhSZWNvcmQgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdtZGRzLWF1dGgtcmVjb3JkJykpO1xuICAgICAgICBpZiAoYXV0aFJlY29yZCAmJiBhdXRoUmVjb3JkLmFjY2Vzc1Rva2VuICkge3JldHVybiB0cnVlO31cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBwcml2YXRlIGdldExvZ291dFRpbWUoKTogbnVtYmVyIHtcbiAgICAgICAgY29uc3QgYXV0aFJlY29yZCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ21kZHMtYXV0aC1yZWNvcmQnKSk7XG4gICAgICAgIGlmIChhdXRoUmVjb3JkKSB7IFxuICAgICAgICAgICAgcmV0dXJuIGF1dGhSZWNvcmQubG9nb3V0VHM7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIDA7XG4gICAgfVxuICAgIC8qIEVuZCAqL1xuXG4gICAgcHJpdmF0ZSBpc0xvZ291dFJlbG9hZCgpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHRoaXMuaXNBdXRob3JpemVkKCkpIHsgXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY3VycmVudFRzID0gRGF0ZS5ub3coKTtcbiAgICAgICAgY29uc3QgbG9nb3V0VHMgPSB0aGlzLmdldExvZ291dFRpbWUoKTtcbiAgICAgICAgaWYgKGN1cnJlbnRUcyAtIGxvZ291dFRzIDwgMTAwMCkgeyBcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNoZWNrQXV0aGVudGljYXRpb24oKSB7XG4gICAgICAgIGNvbnN0IGF1dGggPSB0aGlzLmlzQXV0aDtcbiAgICAgICAgdGhpcy5pc0F1dGggPSB0aGlzLmlzQXV0aG9yaXplZCgpO1xuICAgICAgICBpZiAodGhpcy5pc0F1dGggIT0gYXV0aCkgeyBcbiAgICAgICAgICAgIC8vIGF1dGhlbnRpY2F0aW9uIHN0YXR1cyBjaGFuZ2VkLiBOb3QgYXR0YWNoO1xuICAgICAgICAgICAgdGhpcy5kZXRhY2hlZFJvdXRlSGFuZGxlcyA9IHt9OyAvLyBlbXB0eSB0aGUgbWFwXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKiogRGV0ZXJtaW5lcyBpZiB0aGlzIHJvdXRlIChhbmQgaXRzIHN1YnRyZWUpIHNob3VsZCBiZSBkZXRhY2hlZCB0byBiZSByZXVzZWQgbGF0ZXIgKi9cbiAgICBwdWJsaWMgc2hvdWxkRGV0YWNoKHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogYm9vbGVhbiB7XG4gICAgICAgIGlmIChyb3V0ZS5yb3V0ZUNvbmZpZyAmJiByb3V0ZS5yb3V0ZUNvbmZpZy5wYXRoID09PSAnbGlzdCcpIHtcbiAgICAgICAgICAgIC8vc2F2ZSBjdXJyZW50IHNjcm9sbCBwb3NpdGlvblxuICAgICAgICAgICAgbGV0IGtleSA9IHJvdXRlWydfcm91dGVyU3RhdGUnXS51cmw7XG4gICAgICAgICAgICB0aGlzLnBhZ2VZT2Zmc2V0W2tleV0gPSB3aW5kb3cucGFnZVlPZmZzZXQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJvdXRlLnJvdXRlQ29uZmlnLnBhdGggPT09ICdsaXN0JztcbiAgICB9XG5cbiAgICAvKiogU3RvcmVzIHRoZSBkZXRhY2hlZCByb3V0ZSAqL1xuICAgIHB1YmxpYyBzdG9yZShyb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCwgaGFuZGxlOiBEZXRhY2hlZFJvdXRlSGFuZGxlKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSgpO1xuICAgICAgICBjb25zdCBrZXkgPSByb3V0ZVsnX3JvdXRlclN0YXRlJ10udXJsO1xuICAgICAgICBpZiAoIWhhbmRsZSkgcmV0dXJuO1xuICAgICAgICB0aGlzLmRldGFjaGVkUm91dGVIYW5kbGVzW2tleV0gPSBbaGFuZGxlLCBkYXRlLmdldFRpbWUoKV1cbiAgICB9XG5cbiAgICAvKiogRGV0ZXJtaW5lcyBpZiB0aGlzIHJvdXRlIChhbmQgaXRzIHN1YnRyZWUpIHNob3VsZCBiZSByZWF0dGFjaGVkICovXG4gICAgcHVibGljIHNob3VsZEF0dGFjaChyb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCk6IGJvb2xlYW4ge1xuICAgICAgICB0aGlzLmNoZWNrQXV0aGVudGljYXRpb24oKTtcbiAgICAgICAgbGV0IGRhdGUgPSBuZXcgRGF0ZSgpO1xuICAgICAgICBsZXQga2V5ID0gcm91dGVbJ19yb3V0ZXJTdGF0ZSddLnVybDtcbiAgICAgICAgaWYgKHJvdXRlLnJvdXRlQ29uZmlnICYmIChyb3V0ZS5yb3V0ZUNvbmZpZy5wYXRoID09PSAnbmV3JyB8fCByb3V0ZS5yb3V0ZUNvbmZpZy5wYXRoID09PSAnZWRpdC86aWQnKSkge1xuICAgICAgICAgICAgaWYgKHJvdXRlLmRhdGEgJiYgcm91dGUuZGF0YS5pdGVtKSB7IFxuICAgICAgICAgICAgICAgIHRoaXMuZWRpdEl0ZW1zW3JvdXRlLmRhdGEuaXRlbV0gPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICghcm91dGUucm91dGVDb25maWcgfHwgcm91dGUucm91dGVDb25maWcucGF0aCAhPT0gJ2xpc3QnKSB7ICByZXR1cm4gZmFsc2U7IH1cbiAgICAgICAgaWYgKCF0aGlzLmRldGFjaGVkUm91dGVIYW5kbGVzW2tleV0pIHsgcmV0dXJuIGZhbHNlOyB9XG4gICAgICAgIGlmIChkYXRlLmdldFRpbWUoKSAtIHRoaXMuZGV0YWNoZWRSb3V0ZUhhbmRsZXNba2V5XVsxXSAgPiBDT01QT05FTlRfQ0FDSEVfRFVSQVRJT04pICByZXR1cm4gZmFsc2U7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8qKiBSZXRyaWV2ZXMgdGhlIHByZXZpb3VzbHkgc3RvcmVkIHJvdXRlICovXG4gICAgcHVibGljIHJldHJpZXZlKHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogRGV0YWNoZWRSb3V0ZUhhbmRsZSB7XG4gICAgICAgIGxldCBkYXRlID0gbmV3IERhdGUoKTtcbiAgICAgICAgbGV0IGtleSA9IHJvdXRlWydfcm91dGVyU3RhdGUnXS51cmw7XG4gICAgICAgIGlmICghcm91dGUucm91dGVDb25maWcgfHwgcm91dGUucm91dGVDb25maWcucGF0aCAhPT0gJ2xpc3QnKSByZXR1cm4gbnVsbDtcbiAgICAgICAgaWYgKHJvdXRlLmRhdGEuaXRlbSAmJiAocm91dGUuZGF0YS5pdGVtIGluIHRoaXMuZWRpdEl0ZW1zKSkge1xuICAgICAgICAgICAgZGVsZXRlIHRoaXMuZWRpdEl0ZW1zW3JvdXRlLmRhdGEuaXRlbV07XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5kZXRhY2hlZFJvdXRlSGFuZGxlc1trZXldO1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLmRldGFjaGVkUm91dGVIYW5kbGVzW2tleV0pIHJldHVybiBudWxsO1xuICAgICAgICBpZiAoZGF0ZS5nZXRUaW1lKCkgLSB0aGlzLmRldGFjaGVkUm91dGVIYW5kbGVzW2tleV1bMV0gID4gQ09NUE9ORU5UX0NBQ0hFX0RVUkFUSU9OKSByZXR1cm4gbnVsbDtcbiAgICAgICAgXG4gICAgICAgIGxldCB5T2Zmc2V0ID0gdGhpcy5wYWdlWU9mZnNldFtrZXldO1xuICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIj09cmV0cmlldmU6IFwiLCBrZXksIHlPZmZzZXQpO1xuICAgICAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUbygwLCB5T2Zmc2V0KTtcbiAgICAgICAgICAgIH0sIDIwKTsgLy9zY3JvbGwgdG8gc2F2ZWQgcG9zaXRpb25cbiAgICAgICAgXG4gICAgICAgIHJldHVybiB0aGlzLmRldGFjaGVkUm91dGVIYW5kbGVzW2tleV1bMF07XG4gICAgfVxuXG4gICAgLyoqIERldGVybWluZXMgaWYgYSByb3V0ZSBzaG91bGQgYmUgcmV1c2VkICovXG4gICAgcHVibGljIHNob3VsZFJldXNlUm91dGUoZnV0dXJlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LCBjdXJyOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogYm9vbGVhbiB7XG4gICAgICAgIC8vIEJlbG93IGlzIHRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uO1xuICAgICAgICBpZiAodGhpcy5pc0xvZ291dFJlbG9hZCgpKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIGF1dGhlbnRpY2F0aW9uIHN0YXR1cyBjaGFuZ2VkLiBEb24ndCByZXVzZS5cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZnV0dXJlLnJvdXRlQ29uZmlnID09PSBjdXJyLnJvdXRlQ29uZmlnXG4gICAgfVxufVxuIl19